<!DOCTYPE html>
<!-- saved from url=(0095)https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult -->
<html lang="en">

<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	
	<link rel="preconnect" href="https://www.google-analytics.com/">

	<link rel="preconnect" href="https://www.codeproject.com/">


	<link rel="preload" href="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/logo250x135.gif" as="image">


	<link rel="preload" href="https://www.codeproject.com/App_Themes/CodeProject/Img/logo135-bg.gif" as="image">
	<link rel="preload" href="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/jquery-3.4.1.min.js.download" as="script" type="text/javascript">


	<title>Fededim.Extensions.Configuration.Protected.DataProtectionAPI: The Ultimate Integration between ASP.NET Configuration and Data Protection API- CodeProject</title> 
    
	<link type="text/css" rel="stylesheet" href="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Article.min.css">


    <script type="text/javascript" async="" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/analytics.js.download"></script><script type="text/javascript" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/jquery-3.4.1.min.js.download" defer=""></script>
<script type="text/javascript" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/article.min.js.download" defer=""></script>

	
<meta http-equiv="content-language" content="en-US">

<meta name="Description" content="Fededim.Extensions.Configuration.Protected is an improved ConfigurationBuilder which allows partial or full encryption of configuration values stored inside any possible ConfigurationSource and fully integrated in the ASP.NET Core architecture.">
<meta name="Keywords" content="C#, .NET, encryption, JSON, NET8.0, NET463, appsettings.json, XML, environment, variables">
<meta name="Author" content="Federico Di Marco">
<meta name="Rating" content="General">
<meta name="Revisit-After" content="1 days">
<meta name="application-name" content="CodeProject">
<meta name="google-translate-customization" content="d908bb7ce7aff658-4c2f3a504525c916-g629383f736781a8a-13">



<link rel="dns-prefetch" href="https://ajax.googleapis.com/"> 
<link rel="canonical" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@CodeProject">
<meta name="og:site_name" content="CodeProject">
<meta name="twitter:creator" content="@CodeProject">
<meta property="og:type" content="article">
<meta property="article:published_time" content="12/16/2023 2:31:00 PM">
<meta property="article:modified_time" content="10/1/2024 2:52:00 PM">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Federico Di Marco">
<meta name="twitter:label2" content="Reading time">
<meta name="twitter:data2" content="29 min read">
<meta property="og:url" content="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro">
<meta property="og:title" content="Fededim.Extensions.Configuration.Protected.DataProtectionAPI: The Ultimate Integration between ASP.NET Configuration and Data Protection API">
<meta property="og:description" content="Fededim.Extensions.Configuration.Protected is an improved ConfigurationBuilder which allows partial or full encryption of configuration values stored inside any possible ConfigurationSource and fully integrated in the ASP.NET Core architecture.">


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="144x144" href="https://www.codeproject.com/favicon/apple-touch-icon.png"> 
<link rel="icon" type="image/png" sizes="32x32" href="https://www.codeproject.com/favicon/favicon-32x32.png"> 
<link rel="icon" type="image/png" sizes="16x16" href="https://www.codeproject.com/favicon/favicon-16x16.png"> 
<link rel="manifest" href="https://www.codeproject.com/favicon/manifest.json"> 
<link rel="mask-icon" href="https://www.codeproject.com/favicon/safari-pinned-tab.svg" color="#ff9900">
	<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "TechArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro"
   },
  "name": "Fededim.Extensions.Configuration.Protected.DataProtectionAPI: The Ultimate Integration between ASP.NET Configuration and Data Protection API",
  "headline": "Fededim.Extensions.Configuration.Protected.DataProtectionAPI: The Ultimate Integration between ASP.NET Configuration and Data Protection API",
  "url": "https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro",
  "discussionUrl": "https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro#_comments",
  "isFamilyFriendly": "true",
  "image": "https://www.codeproject.com/App_Themes/CodeProject/Img/Article100.png",
  "keywords": "C#,.NET,encryption,JSON,NET8.0,NET462,appsettings.json,XML,environment,variables",
  "commentCount": "0",
  "editor" : {
    "@type" : "Person",
    "name" : "Editor",
    "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=3865041"
  },
  "license": "http://www.codeproject.com/info/cpol10.aspx",
  "publisher" : {
    "@type" : "Organization",
    "name" : "CodeProject"
  },
  "description": "Fededim.Extensions.Configuration.Protected implements a custom ConfigurationBuilder and a custom ConfigurationProvider defining a custom tokenization tag which whenever found inside a configuration value decrypts the enclosed encrypted data using a pluggable encryption/decryption provider (a default one based on ASP.NET Core Data Protection API is provided).",
  "articleSection": "encryption",
  "author" : [{
      "@type" : "Person",
      "name" : "Federico Di Marco",
      "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=3865041"
    }],
  "datePublished": "2023-12-16",
  "dateCreated": "2023-12-16",
  "dateModified": "2024-10-01"
,
  "contentRating" : {
    "@type" : "Rating",
    "ratingValue" : 5.00,
    "bestRating" : 5,
    "worstRating" : 1
  }
}</script>

<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=security",
      "name" : "security"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=encryption",
      "name" : "encryption"
    }
  }]
}</script>


	<!--<base target="_top">--><base href="." target="_top">
	
    


<script type="text/javascript">
function defrm () { /* thanks twitter */
    document.write = '';
    window.top.location = window.self.location;
    setTimeout(function() { document.body.innerHTML = ''; }, 0);
    window.self.onload = function(evt) { document.body.innerHTML = ''; };
}

if (window.top !== window.self) {
    try {
        if (window.top.location.host) { /* will throw for all except chrome */ }
        else { defrm(); /* chrome */ }
    } catch (ex) { defrm(); /* everyone else */ }
}

// Specific case where a site is screwing with us.
if (typeof(DemoUrl) !== 'undefined') {
    document.write(unescape('%3Cme') + 'ta http' + '-equiv="re' + 'fresh con' +
                           'tent="1;url=' + DemoUrl + unescape('"%3CE'));
}
</script>
	





    <script async="" type="text/javascript" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/js"></script>
	<!-- Setup Google Analytics -->
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-R88806Q2ER"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'G-R88806Q2ER');
	</script>

<style type="text/css"></style></head>	

<body class="chrome chrome130">



<a class="access-link" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult#Main"><img alt="Click here to Skip to main content" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/t.gif"></a>




<div class="page-background">

	
	

	

	
    <div id="ctl00_STM" class="site-top-menu fixed narrow">
        <div class="main-content">
            

<div class="container memberbar clearfix flex-container flex-extend">

	<div id="ctl00_MemberBar_GenInfo" class="flex-item align-left">65,938 articles</div>
	
	<div id="ctl00_MemberBar_ChangeNotice" class="flex-item align-left">CodeProject
	is changing. <a href="https://www.codeproject.com/info/Changes.aspx">Read more</a>.</div>

	<div class="flex-item">
		
	</div>

	<div class="flex-item align-right">

		

		

		
	</div>
</div>
        </div>
    </div>

	
    <div id="ctl00_SH" class="site-header fixed narrow">
        <div class="main-content">
            <div class="logo"><a href="https://www.codeproject.com/"><img id="ctl00_Logo" tabindex="1" title="CodeProject" src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/logo250x135.gif" alt="Home" style="height:135px;width:250px;border-width:0px;"></a></div>
            <div class="promo"></div>
        </div>
    </div>

	
			
	

	<div id="A" class="container-content-wrap fixed narrow"> 

	<div class="container-content">

        
		<div class="clearfix">
			<div class="container-breadcrumb float-left ">
				<div><a rel="nofollow" href="https://www.codeproject.com/script/Content/SiteMap.aspx">Articles</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=security">security</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=encryption">encryption</a></div>
			</div>

            <div class="float-left">
				
			</div>

			<div class="edit-links float-right">
				



 
&nbsp;










			</div>

			<div class="article-nav float-right">
				


<div style="display:inline-block;position:relative;top:-6px;margin-right:20px">
    
</div>



 

<a id="ctl00_ActionLinks_PrintMd" data-tooltip="Print" data-enabletooltip="true" data-width="auto" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro?display=Print" class="tooltip" title="">
   <img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/print48.png" width="24" height="24" style="border:0">
<div class="speech-bubble-container-up" style="width:auto">  <div class="speech-bubble-up" style="text-align:center"> Print</div>  <div class="speech-bubble-pointer-up">    <div class="speech-bubble-pointer-up-inner"></div>  </div></div></a>



<span id="ctl00_ActionLinks_R">
    
    
</span>
			</div>
		</div>

        
		<div class="extended article-container-parts">

			
		    
            

			
			<div id="AT" class="article-container  fixed narrow" style="max-width:inherit;"> 

				<div class="article">

					<form name="aspnetForm" method="post" action="https://www.codeproject.com/Articles/5374311/View.aspx" id="aspnetForm" style="margin:0;padding:0">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="iibOa8OfXykOFQqRWkn7++DJvNgWJiS5bzlDaIOv37x9JySqV+L4ulRqibkSNqTQ2ecyeFOWI7zm9lryOuqCklH9Zh+Zh6K3NfRqUsrazmIW9+Hi+9f8DhQpEYs9JfDH/9Ayo6L47NYzt4Wa6MHzKwy4WY8DLSHnBtcg8Pz6KFrSk2D5YGrP6yZ4+oRifcYMnWbOcOExmbqzO75ydt60ncdu6HIGQSWJrKFW2zFJtiHRxO3Sp5akZyTPOcIuGzPODrPJUa9aTCNQpW8VEVyj5H/5UBhHko+YWoAXGrYkR97j0mDRgWVYDTFq+1smQK8tCbxx4clla7jXi7As/e0mQdPpqAVcOPYYRJiq9R03bRcZtE9cud9B4CfMK+Q2ZX5sKN5PhrE9XtgRdbA4l7YXr/XpQ/8X9eDO9DBz+87lfAIdQreyySKAOvh2B0SV2e0g19OUcVfCf3Jv65ff1amrBn2Uv56f+1JMXM4pQ7sWQwUseaj2is822vXpce9ZhqmklywxMbSAdnM4Z87WjjplJHOCtgIo2M8zz96JYusAHA4W/isvTj+TDaMKvONyDleiLN7nW011z4JApRUiMuM6NE7P425++cvoIXM2WBP2pWbfekHclVvfGy3nfohZJaAxQ4swvbZPIW7FetOoghRn7riUluLe0zXHUFBpwF0UqZPBE6c4jDysQAGLgOK46sF3ih5x2dE03BBB4wHrF2pypZUczmCXVAMBevWa59zhr8hFdtfnhGa+L1CHwdkcagptmiuN8zdc/QajY2QzF0buNis8JlXpo//1EDl79Ps5gePHWo697RJFIR/irJQ0wfq3FuCGtzfELuLd1bvfJq/i5DjNFn9SDQc2VuYdEGpLPjmyyl4wIi7VAxpgC1D+vgnRtiC8RUTppZu+1OD07emtup0honaKXF5ntmFCVK+rupFr6oruAxP7F47q5KuRzUFV3PH6nfi0q90mCm9CmvKigjfrdu/QCNkLj8cOZ3NXXh9pMkvfuBdeGDxiUhbVazBbvGL2HVs5m92vN6qJ2j5tbQ9775f+lNkNVOs+BIYH1JtIaCPocS/rJeVIc/r+RnFrPlrF5HJzjD7U3GtK9raApE0ehE/Y0BQ5XFY9MANBJzFYdjAf3mF3Ns/lA4Om04j0t/VtMJN45V/KapQKVb8iIwdvjRrr/hI+od1gfmNVrKWi0tRSIz5P+hTA78/Bgr1RqPQ142dIK/3pzDBqSYk629qHxIctwgnnPyaIbK0nNThfirgwgUIwLR9WNGsh/B6Muv61UXs02UKOKsRX83fNrYwxPFgP4XiWGXJ8+4pkid9YV4mUpej0noUDm9ylJBSaF1jDI/6lr5fmcfkITqzxWamm5qw4YQzAyhrGV++UlRKcMbBtQntxxVNXQnY25vW5TFyHgXp8XCMxEv5213l/8Vm9GombgEwruAwUm11CSgBQfKvB0SYrqQjPrMbPiamsDeIQIimKcsw62B2N8Qi4G3CdOg8DDpiHmSgFB/SgoS5rWAbIPXAZxvHiUtttBMtNKuJzBE0ftaPDi9Q7decls/iaXyY73NxipgUzWc7+kAfRJ1bLb12XCD2Wh0o+JUxMM/7YSkg3aGqeeMPfZuOWi0eSZpiV47BAaRN0oAasE+7wzUiOx8DJEHsUf7njRalEltIjUScn7C0kqzYfFuuL6nOTYGJk4N/IDsZMLHWk3XwGNsLMil7MIQxsZjOOFyozxEu+pYKIgoNqAXB+SsnV4zhqt22Qz8G18eBUH6aW3xyvfqS/27QaJ9VZc6U3dqHP22sHorBJWHkiRR9MlrDcoOmuIxBUY306kBgixUopQsajLhVcfKw+k1eLB9QQfT1kpAE6/hB9gdyy+6J1B1UlSAUY/t+/+hxnfHdnY8DIsm5vHOjXrs4YzpSnrHAOuAG8UiV4riLzDUov69ljftoFu+il+oYyAfECjtnY14K5nQb+GnJzOmjrRrPzKXrdn4x6LHnOSNcuEnyHaHVEEf59Lor3GWyRN941C7DbI2EgckIieHEx+fau/K+b/cDDj/hntK072KQJBGqYqa1gOKG8GsaRZbpghiOb85jc7BS/XNPwN603Pah6SLJxvGAtAG4RyftGfwYAn+0jsoOtzadFqPAZtBXnjbYHW2TQPrwqCOt2z+7Zkj9Hj4WLXjBCTu/C+JiBG1skimPoZtEfsLg4dYjb8TTCL/40AmQ/mdjWqAW82L170/pJD0nG3wAQkl8AqUJp9RuASYrU6vVJcFFsFSnSQC/+ydZLee5UZhMrCG37lDutqzDuw1MwRbSODs35PC+QiAWTPjlewnp1LMCBk9rv+eOwKL0NJxwXJC0bfZuTeID5ysrWp+8txpwAf6grQsLGQ01D63J1ydtZWWNkwtZlgZQrhvg+gblZA/Y2LE3XvQOzSLsPRv46QFvJsOrwe6ePbVi3bKGE/uuc2MUYb4gSuYikU1yypwwOWkAYC6lu1bO+HoOVd1pdKiDF3Sz0hoWvEm53HpGwhnmb+9WDvvJeWVhq8+qVfBvrfHJqLAh3+/CB97Eo3rmSm1qdQFILYN68hooKJf7rn1YJFC6QfY2HTa8S8/tvMgwWX8zrRSqhYpaQ+lrnthiLFSoPPeU490UES3KJdxMuQhWaHPvjTSY3Dug50GPooQo+tNhKNbKZt0SwF1LOpBaUgVkBUeM6Bz0kkd4LsUhPQfx0Px40rXgO5XPZEHKWrsQWtwXSI5+g42ANrqloxq8xk5geUSOuqTRdIW8O+3tzpRmGzTqd7alOfykJBu6W7iXR+j/AFg8JGwsLtZNsMk5rKv+r2S8bYM4gdHQWHu8BMcE6fjUo2M1Lm3Y=">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="10C1FD69">
</div>

					
					 
					<div class="header">
					    <a name="Main"></a>
					    <a name="_articleTop" id="_articleTop"></a>

					    
						<div>
							<span id="ctl00_TagListHorz_TagWrp" class="tags horizontal">

	
	

	
	<span id="ctl00_TagListHorz_VisibleTags"><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/Csharp" data-id="81">C#</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/.NET" data-id="98">.NET</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/encryption" data-id="415">encryption</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/JSON" data-id="997">JSON</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/NET6.0" data-id="5231">NET6.0</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/appsettings" data-id="5583">appsettings</a></div></span> 

	
	
</span>


						</div>
					    <div class="title">
					        <h1 id="ctl00_ArticleTitle">Fededim.Extensions.Configuration.Protected.DataProtectionAPI: The Ultimate Integration between ASP.NET Configuration and Data Protection API</h1>
					    </div>

                        <div>
					        
					        <div class="entry flex-container">

								

                                <div class="flex-item" style="flex:1 1 auto">
                                    <div class="flex-container" style="justify-content:space-between;flex-wrap:wrap-reverse">
                                       <span id="ctl00_Authors" class="author flex-item"><a href="https://www.codeproject.com/script/Membership/View.aspx?mid=3865041" rel="author">Federico Di Marco</a></span> 

                                        <div class="flex-item" style="margin-top:-4px;">
                                            <div id="ctl00_RateArticle_RatingTable" class="small-text" data-objectref="2_5374311">

	<meta itemprop="upvoteCount" content="5">


	<div id="ctl00_RateArticle_RatingRow" class="flex-container rating-container large-stars">

					
		

		
		<div class="nowrap tooltip">

			
			<div id="ctl00_RateArticle_ResultNoHist" class="rating-result"><div class="flex-container rating-stars large-stars"><div><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/star-fill-lg.png" style="width:24px;height:24px"></div></div></div>
			

			
			

			
            

			
                

		</div>
		
	
		
		<div id="ctl00_RateArticle_VoteCountNoHist" class="rating-votes nowrap">5.00/5  (5 votes)</div>	

		

		
		<div class="rating-undo" title="Undo vote" style="margin-left:5px;display:none"></div>

		
		
	</div>

	
	

</div>

                                        </div>
                                    </div>

                                    <div class="flex-container" style="color:#666;font-size:smaller">
                                        <span id="ctl00_LastUpdated" class="date flex-item-tight" title="Date last updated">1 Oct 2024</span><a id="ctl00_LicenseLink" title="The Code Project Open License (CPOL)" class="license flex-item-tight" href="http://www.codeproject.com/info/cpol10.aspx">CPOL</a><span id="ctl00_ReadingTime" class="stats flex-item-tight">29 min read</span><span id="ctl00_HorizontalStats" class="stats flex-item-tight"><span class="stats"><span title="Views"><img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/views32.png" style="width:16px"> 44.6K</span> &nbsp; </span></span>
                                    </div>
                                </div>
					        </div>

                            

                        </div>

                        <div id="ctl00_DescriptionSpot" class="summary">Fededim.Extensions.Configuration.Protected is an improved ConfigurationBuilder which allows partial or full encryption of configuration values stored inside any possible ConfigurationSource and fully integrated in the ASP.NET Core architecture.</div><span id="ctl00_ThumbnailUrl" class="date" content="https://www.codeproject.com/script/Articles/Images/article100x80.png"></span>			

                    </div>
                    
					
					

					

					
					<div id="ctl00_Abstract" class="abstract">Fededim.Extensions.Configuration.Protected implements a custom ConfigurationBuilder and a custom ConfigurationProvider defining a custom tokenization tag which whenever found inside a configuration value decrypts the enclosed encrypted data using a pluggable encryption/decryption provider (a default one based on ASP.NET Core Data Protection API is provided).</div>

					
					

						
					

					

						
						<div id="contentdiv" class="text">
						



<!-- Article Starts -->

<h2>Introduction</h2>

<p>Almost one month ago, I posted this article <a href="https://www.codeproject.com/Articles/5372873/ProtectedJson-Integrating-ASP-NET-Core-Configurati"><strong>ProtectedJson</strong></a> about an improved <code>ConfigurationSource</code> and <code>ConfigurationProvider</code> for JSON files which allowed partial or full encryption of configuration values using Data Protection API. Some comments came through and one which was not so "meaningful" had a question whether my package also supported environment variables.</p>

<p>Even though we could wonder why someone ever wants to encrypt/decrypt environment variables, this question made me have an epiphany: can what I had already done for JSON files also be extended to other configuration sources ? After a small proof of concept project after work, the answer was yes and after some rework, I published a new package <a href="https://www.nuget.org/packages/Fededim.Extensions.Configuration.Protected"><strong>Fededim.Extensions.Configuration.Protected</strong></a> which is, most of all, an improvement and an extension of <code>ProtectedJson</code> to support encryption/decryption of configuration values stored inside <strong>ANY </strong>configuration source.</p>

<h2>Key Features</h2>

<ul>
	<li>Encrypt partially or fully a configuration value</li>	<li>Works with any existing and (hopefully) future <code>ConfigurationSource</code> and <code>ConfigurationProvider</code> (successfully tested with framework's builtin providers like <code>CommandLine, EnvironmentVariables, Json, Xml and InMemoryCollection</code>)</li>	<li>Transparent in memory decryption of encrypted values without almost any additional line of code</li>	<li>Supports a global configuration and an eventual custom override for any <code>ConfigurationSource</code></li>	<li>Supports almost any NET framework (net6.0, netstandard2.0 and net462)</li>	<li>Pluggable easily into any existing NET / NET Core project</li>	<li>Supports automatic re-decryption on configuration reload if underlying <code>IConfigurationProvider</code> supports it</li>	<li>Supports per configuration value encryption derived subkey (called "subpurposes")</li>	<li>Supports pluggable encryption/decryption with different providers implementing a standard interface <code>IProtectProvider </code>(since version 1.0.12, keep in mind that implementing a secure and robust encryption/decryption provider requires a deep knowledge of security!).</li></ul>

<h2>Background</h2>

<p><a href="https://learn.microsoft.com/en-GB/aspnet/core/fundamentals/configuration/?view=aspnetcore-6.0">ASP.NET Configuration</a> is the standard .NET Core way of storing application configuration data through hierarchical key-value pairs inside a variety of configuration sources (usually JSON files, but also environment variables, XML file, in memory dictionaries, command line parameters or any custom provider you would like to implement). <em>While .NET Framework used a single source (usually, a XML file which was intrinsically more verbose), .NET Core can use multiple ordered configuration sources, which gets "merged" allowing the concept of overriding of the value of a key in a configuration source with the same one present in a subsequent configuration source</em>. This is useful because in software development, there are usually multiple environments (Development, Integration, PRE-Production and Production) and each environment has its own custom settings (for example, API endpoints, database connection strings, different configuration variables, etc.). In .NET Core, this management is straightforward, in fact, you usually have two JSON files:</p>

<ul>
	<li><em>appsettings.json</em>: which contains the configuration parameters common to all environments</li>	<li><em>appsettings.&lt;environment name&gt;.json</em>: which contains the configuration parameters specific to the particular environment</li></ul>

<p>ASP.NET Core apps usually configure and launch a <em>host</em>. The host is responsible for app startup, configuring dependency injection and background services, configuring logging, lifetime management and obviously configuring application configuration. This is done mainly in two ways:</p>

<ul>
	<li>Implicitly, by using one of the framework provided methods like <code>WebApplication.CreateBuilder</code> or <code>Host.CreateDefaultBuilder</code> (usually called inside the <em>Program.cs</em> source file) which substantially do:

	<ul>
		<li>Read and parse command line arguments</li>		<li>Retrieve environment name respectively from <code>ASPNETCORE_ENVIRONMENT</code> and <code>DOTNET_ENVIRONMENT</code> environment variable (set either in the operating system variables or passed directly in the command line with <code>--environment</code> argument).</li>		<li>Read and parse two JSON configuration files named <em>appsettings.json</em> and <em>appsettings.&lt;environment name&gt;.json.</em></li>		<li>Read and parse the environment variables.</li>		<li>Call the delegate&nbsp;<code>Action&lt;Microsoft.Extensions.Hosting.HostBuilderContext, Microsoft.Extensions.Configuration.IConfigurationBuilder&gt;</code>&nbsp;of&nbsp;<code>ConfigureAppConfiguration</code>&nbsp;where you can configure the app configuration through&nbsp;<code>IConfigurationBuilder</code>&nbsp;parameter</li>	</ul>
	</li>	<li>Explicitly by instantiating the <code>ConfigurationBuilder</code> class and using one of the provided extensions methods:
	<ul class="method">
		<li><code>AddCommandLine</code>: to request the parsing of command line parameters (either by <code>--</code> or <code>-</code> or <code>/</code>)</li>		<li><code>AddJsonFile</code>: to request the parsing of a JSON file specifying whether it is mandatory or optional and whether it should be reloaded automatically whenever it changes on filesystem.</li>		<li><code>AddXmlFile</code>: to request the parsing of an XML file specifying whether it is mandatory or optional and whether it should be reloaded automatically whenever it changes on filesystem.</li>		<li><code>AddEnvironmentVariables</code>: to request the parsing of environment variables</li>		<li>etc.</li>	</ul>
	</li></ul>

<p>In essence, every <code>Add&lt;xxxx&gt;</code> extension method adds a <code>ConfigurationSource</code> to specify the source of key-value pairs (CommandLine, Json File, Environment Variables, etc.) and an associated <code>ConfigurationProvider</code> used to load and parse the data from the source into the <code>Providers</code> list of <code>IConfigurationRoot</code> interface which is returned as a result of the <code>Build</code> method on <code>ConfigurationBuilder<i> </i></code>class as you can see the picture below.</p>

<p>(Inside <code>configuration.Providers</code>, there are six sources: <code>CommandLineConfigurationProvider</code>, two <code>JsonConfigurationProvider</code> for both <em>appsettings.json</em> and <em>appsettings.&lt;environment name&gt;.json,</em> a <code>XMLConfigurationProvider</code> for the XML file <em>appsettings.xml</em>, a <code>MemoryConfigurationProvider</code> for the provided dictionary and finally <code>EnvironmentVariableConfigurationProvider</code> for the environment variables).</p>

<p><img src=".	" alt="Image 1" style="cursor: pointer; border: 0; width: 700px; height: auto" onclick="imageCleanup.showFullImage(&#39;./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg&#39;)" class="lazyautosizes lazyloaded" data-sizes="auto" data-srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 1920w" sizes="700px" srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Configuration_Providers.jpg 1920w"></p>

<p>&nbsp;</p>

<p>As I wrote earlier, the order in which the <strong>Add&lt;xxxx&gt; extension methods</strong> are called is important because when the <code>IConfigurationRoot</code> class retrieves a key value, it uses the <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationRoot.cs#L114-L127">GetConfiguration </a>method which cycles the <code>Providers</code> list in a <em>reversed</em> order trying to return the first one which contains the queried key, thus simulating a "merge" of all configuration sources (LIFO order, Last In First Out).</p>

<p>&nbsp;</p>

<h2>Using the Code</h2>

<p>You find all the source code on <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/tree/master/Fededim.Extensions.Configuration.Protected">my Github repository</a>, the code is based on .NET 6.0 and Visual Studio 2022. Inside the solution file, there are five projects, two about the older <code>ProtectedJson</code> and three about this new <code>Protected</code> package, let's talk about the last four:</p>

<ul>
	<li><a href="https://www.nuget.org/packages/Fededim.Extensions.Configuration.Protected"><code>Fededim.Extensions.Configuration.Protected</code></a>: Essentially this package implements the core logic to integrate with Microsoft ASP.NET Core Configuration API, delegating all the encryption/encryption code to a pluggable external provider implementing the interfaces <code>IProtectProvider </code>(dealing with the core logic of encryption/decryption) and <code>IProtectProviderConfigurationData</code>,<code> </code>an abstract class for specifying the configuration options and plugging the providers into <code>ProtectedConfigurationBuilder</code>, the enabling class for decryption of any configuration value stored inside any configuration source.<code> </code>Other types implemented by this package are <code>ProtectedConfigurationProvider </code>(the main class actually responsible for decryption of configuration values), <code>ConfigurationBuilderExtensions</code> which contains the extension methods for <code>IConfigurationBuilder</code> interface (<code>WithProtectedConfigurationOptions</code> used to specify a particular configuration which applies only to a specific <code>ConfigurationSource</code>) and <code>ProtectFileOptions/ProtectFileProcessors</code> (<code>XmlProtectFileProcessor, JsonProtectFileProcessor, JsonWithCommentsProtectFileProcessor, RawProtectFileProcessor</code>) used to read, decode, encrypt and re-encode source files. <a href="https://www.nuget.org/packages/Fededim.Extensions.Configuration.Protected">This package has been published on NuGet.Org</a>.<br>
	<br>
	A standard provider based on <strong>Microsoft Data Protection API</strong> is provided by the companion package <strong>Fededim.Extensions.Configuration.Protected.DataProtectionAPI</strong><em>, you can reference just this package in your project if you do not plan to develop another encryption/decryption provider (</em><strong>again keep in mind that implementing a secure and robust encryption/decryption provider requires a deep knowledge of security!</strong><em>).</em><br>
	&nbsp;</li>	<li><a href="https://www.nuget.org/packages/Fededim.Extensions.Configuration.Protected.DataProtectionAPI"><code>Fededim.Extensions.Configuration.Protected.DataProtectionAPI</code></a>: This is the standard Microsoft Data Protection API encryption/decryption provider which implements the interface <code>IProtectProvider</code> and the abstract class <code>IProtectProviderConfigurationData </code>respectively with its classes <code>DataProtectionAPIProtectProvider</code> and <code>DataProtectionAPIProtectConfigurationData.&nbsp;</code><a href="https://www.nuget.org/packages/Fededim.Extensions.Configuration.Protected.DataProtectionAPI">Again this package has been published on NuGet.Org.</a><br>
	&nbsp;</li>	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/tree/master/Fededim.Extensions.Configuration.Protected.DataProtectionAPITest"><code>Fededim.Extensions.Configuration.Protected.DataProtectionAPITest</code></a>: This a <code>xUnit </code>test project which tests thoroughly the two above packages in order to improve the reliability and the code quality. It creates sample data for all&nbsp;<code>ConfigurationSources</code> provided by MS .NET&nbsp; (a JSON file, a XML file, environment variables, an in-memory dictionary and command line arguments) containing a 2*fixed set of keys (10000),&nbsp;one in plaintext with random datatype&nbsp;and value&nbsp;and another with the same value but encrypted. It loads then the sample data with&nbsp;<code>ProtectedConfigurationBuilder</code> in order to decrypt&nbsp;it and tests that all plaintext values are the same as those that have been decrypted.<br>
	&nbsp;</li>	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/tree/master/Fededim.Extensions.Configuration.Protected.ConsoleTest"><code>Fededim.Extensions.Configuration.Protected.ConsoleTest</code></a>: This is a console application which shows how to use <code>ProtectedConfigurationBuilder</code> by reading and parsing six encrypted bespoke configuration sources and converting them to a strongly type class called <code>AppSettings</code>. The decryption happens flawlessly and automatically without almost any line of code, let's see how.</li></ul>

<p>To use the automatic decryption feature, you have just to replace the call <code>new ConfigurationBuilder()</code> with a call to <code>new ProtectedConfigurationBuilder()</code> passing to it the configuration of the pluggable encryption/decryption provider. After having done that, you can add any existing configuration source by using the standard methods like <code>AddCommandLine</code>, <code>AddJsonFile</code>, <code>AddXmlFile</code>, <code>AddInMemoryCollection</code>, <code>AddEnvironmentVariables</code> or even future configuration sources since this package should support all of them as long as the <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationProvider.cs#L61-L94">implementation of the GetChildKeys of Microsoft.Extensions.Configuration.ConfigurationProvider</a> does not change (keep reading below to understand the reason). The constructor for <code>ProtectedConfigurationBuilder</code>&nbsp;takes just one parameter, a configuration class derived from the <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectProviderConfigurationData.cs#L38-L90"><code>IProtectProviderConfigurationData</code></a>, an abstract class (implemented by one of the available providers) which is used for specifying the configuration options and plugging the providers into <code>ProtectedConfigurationBuilder. </code>There are four common fundamental parameters which must be specified by every provider:</p>

<ul>
	<li><code>ProtectedRegex</code>: It is a regular expression which specifies the tokenization tag which encloses the encrypted data to be decrypted; it must define a named group called <code>protectedData </code>(and optionally two additional groups called <code>subPurposePattern </code>and <code>subPurpose </code>for specifying a per configuration value subkey). If <code>null</code>, this parameter assumes the default value:

	<div class="pre-lang" id="premain640914"><div>C#</div><div class="pre-action-link"><span id="copycode640914" class="copy-code" data-index="640914" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre640914" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedRegexString = <span class="code-string">"</span><span class="code-string">Protected(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectedData&gt;.*?)}"</span>;</pre>

	<p>The above regular expression essentially searches in a lazy way (so it can retrieve all the occurrences inside a value) for any <code>string</code> matching the pattern <code>'Protected:{&lt;subPurpose&gt;}:{&lt;encrypted data&gt;}'</code> and extracts the <code>&lt;encrypted data&gt;</code> substring storing it inside a group named <code>protectedData</code>. There is also an <strong>optional </strong>part called &lt;<code>subPurposePattern&gt;</code> (made up of<code> :{&lt;subPurpose&gt;}</code>)<code> </code>which allows to specify per configuration value encryption derived subkey (called "subpurposes", idea borrowed originally from Data Protection API). If you do not like this tokenization, you can replace it with any other one you prefer by crafting a regular expression with the constraint that it extracts the <code>&lt;encrypted data&gt;</code> substring in a group called <code>protectedData </code>and the &lt;<code>subPurposePattern&gt;</code> and <code>&lt;subPurpose&gt;&nbsp;</code>substrings in two groups called respectively <code>subPurposePattern</code> and <code>subPurpose.</code></p>
	</li>	<li>	<p><code>ProtectRegex</code>: It is a regular expression which specifies the tokenization tag which encloses the data to be encrypted; again it must define a named group called this time&nbsp;<code>protectData </code>(and optionally two additional groups called <code>subPurposePattern </code>and <code>subPurpose </code>for specifying a per configuration value subkey). If <code>null</code>, this parameter assumes the default value (e.g.&nbsp;<code>Protect:{&lt;subPurpose&gt;}:{&lt;data to be encrypted&gt;}</code>):</p>

	<div class="pre-lang" id="premain1983"><div>C#</div><div class="pre-action-link"><span id="copycode1983" class="copy-code" data-index="1983" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre1983" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectRegexString = <span class="code-string">"</span><span class="code-string">Protect(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectData&gt;.*?)}"</span>;</pre>
	</li>	<li>	<p><code>DefaultProtectedReplaceString:</code> It is a string expression used to transform the plaintext tokenization into the encrypted tokenization (e.g. from&nbsp;<code>Protect:{&lt;subPurpose&gt;}:{&lt;data to be encrypted&gt;}</code> into&nbsp;<code>Protected:{&lt;subPurpose&gt;}:{&lt;encrypted data&gt;}</code>). It contains two placeholders <code>${subPurposePattern}</code> and <code>${protectedData}</code>&nbsp;which gets substituted respectively with the subPurposePattern (if present) and the encrypted data.&nbsp;If <code>null</code>, this parameter assumes the default value:</p>
	</li></ul>

<div class="pre-lang" id="premain471217"><div>C#</div><div class="pre-action-link"><span id="copycode471217" class="copy-code" data-index="471217" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre471217" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedReplaceString = <span class="code-string">"</span><span class="code-string">Protected${subPurposePattern}:{${protectedData}}"</span>;</pre>

<ul>
	<li><code>IProtectProvider</code>: this is a standard&nbsp;interface which must be implemented by the&nbsp;pluggable provider providing the encryption/decryption services.</li></ul>

<p>By default a standard encryption/decryption provider based on&nbsp;Microsoft Data Protection API is provided in the companion package <strong>Fededim.Extensions.Configuration.Protected.DataProtectionAPI. </strong>Its&nbsp;configuration class implementing <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectProviderConfigurationData.cs#L38-L66"><code>IProtectProviderConfigurationData</code></a>&nbsp;is called&nbsp;<strong><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.DataProtectionAPI/DataProtectionAPIProtectConfigurationData.cs#L143-L202">DataProtectionAPIProtectConfigurationData</a> </strong>whose constructor takes these additional inherent parameters besides the above three common <code>ProtectedRegex,ProtectRegex </code>and&nbsp;<code>DefaultProtectedReplaceString</code>&nbsp;ones:</p>

<ul>
	<li><code>dataProtectionServiceProvider</code>: This is a <code>IServiceProvider</code> interface needed to instance the<em> <code>IDataProtectionProvider</code></em> of Data Protection API in order to decrypt the data. This parameter is mutually exclusive to the next one.</li>	<li><code>dataProtectionConfigureAction</code>: This is an <code>Action&lt;IDataProtectionBuilder&gt;</code> used to <a href="https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-8.0&amp;viewFallbackFrom=aspnetcore-2.2">configure the Data Protection API</a> in standard NET Core. Again, this parameter is mutually exclusive to the previous one.</li>	<li><code>purposeString</code>: used to specify explicitly a purpose string to use for encryption. Data Protection API supports multiple encryption keys which are derived from the configured master key and strictly connected to one or more <code>purpose</code> string passed to the <code>CreateProtector</code> API, for further information please read <a href="https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/consumer-apis/purpose-strings?view=aspnetcore-8.0">here </a>and <a href="https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/consumer-apis/purpose-strings-multitenancy?view=aspnetcore-8.0">here</a>.</li>	<li><code>keyNumber</code>: this parameter is alternative to <code>purposeString</code> for convenience<font color="#990000" face="Consolas, monospace, mono"><span style="font-size: 15px"> </span></font>(we are more used to think of different key numbers rather than different purposes), it is used to specify a key index (the default value is 1) to use for encryption, under the hood the provided index is used to construct the <code>purpose</code> string <code>$"Key{keyNumber}" (</code>see <code>ProtectedConfigurationBuilder.ProtectedConfigurationBuilderKeyNumberPurpose </code>method)</li></ul>

<p>The <code>dataProtectionServiceProvider</code> and <code>dataProtectionConfigureAction</code> parameters are somewhat a drawback, because they represent a reconfiguration of another dependency injection for instantiating the <code>IDataProtectionProvider</code> needed to decrypt the data.</p>

<p>In fact, in a standard NET Core application, usually the dependency injection is configured <strong>after </strong>having read and parsed the configuration file (so all configuration sources and providers do not use DI), but in this case, I was compelled since the only way to access Data Protection API is through DI. Moreover, when configuring the dependency injection, the parsed configuration usually gets binded to a strongly typed class by using <em><code>services.Configure&lt;&lt;strongly typed settings class&gt;&gt;(configuration)</code></em> so it's a dog chasing its tail (for decrypting configuration you need DI, for configuring DI, you need the configuration parsed in order to bound it to a strongly typed class). The only solution I came up for now is reconfiguring a second DI <code>IServiceProvider</code> just for the Data Protection API and use it inside <code>ProtectedConfigurationProvider</code>. To configure the second DI <code>IServiceProvider</code>, you have two options:</p>

<ul>
	<li>You create it by yourself (by instantiating a <code>ServiceCollection and</code> calling <code>AddDataProtection</code> on it)</li>	<li>You let <code>ProtectedConfigurationProvider</code> to create it by passing a <code>dataProtectionConfigureAction</code> parameter. In this case, in order to avoid duplicated code, the configuration of Data Protection API can be performed inside a common <code>private</code> method called <code>ConfigureDataProtection</code>, e.g.:</li></ul>

<div class="pre-lang" id="premain600221"><div>C#</div><div class="pre-action-link"><span id="copycode600221" class="copy-code" data-index="600221" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre600221" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">private</span> <span class="code-keyword">static</span> <span class="code-keyword">void</span> ConfigureDataProtection(IDataProtectionBuilder builder)
{
    builder.UseCryptographicAlgorithms(<span class="code-keyword">new</span> AuthenticatedEncryptorConfiguration
    {
        EncryptionAlgorithm = EncryptionAlgorithm.AES_256_CBC,
        ValidationAlgorithm = ValidationAlgorithm.HMACSHA256,

    }).SetDefaultKeyLifetime(TimeSpan.FromDays(365*15)).PersistKeysToFileSystem
                                              (<span class="code-keyword">new</span> DirectoryInfo(<span class="code-string">"</span><span class="code-string">..\\..\\Keys"</span>));
}</pre>

<p>Here, I chose to use AES 256 symmetric encryption with HMAC SHA256 as digital signature function. Moreover, I ask to store the master encryption key metadata (key, iv, hash algorithm, etc.) in an XML file inside the <em>Keys</em> folder of the console app (by default, keys are stored in a particular location according to <a href="https://learn.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/default-settings?view=aspnetcore-8.0">MS key management documentation</a>, note that all these APIs are provided by default by the Data Protection API).</p>

<p>So when you start the app for the first time, the Data Protection API creates automatically the master encryption key and stores it in the <em>Keys</em> folder, in the following runs, it loads it from this XML file. This configuration however is not the best approach from the security viewpoint because the key is stored in plain text, if you want to encrypt the master key at rest, you can use the <code>ProtectKeysWithDpapi </code>extension method (works only in Windows and in this case, it would be encrypted with Windows DPAPI) or <code>ProtectKeysWithCertificate </code>to encrypt it with a certificate installed on the computer. Please note that even though you can use different encryption keys in the <em>Keys </em>folder, there is just one master key from which all encryption keys are derived using the <em>purpose string </em>crafted from either the <code>keyNumber </code>parameter or the <code>purposeString </code>parameter specified either in the <code>ProtectedConfigurationBuilder</code> or in the <code>WithProtectedConfigurationOptions</code> extension method.</p>

<p>In the console application, I add the six configuration sources in the following order to exemplify the merging feature of ASP.NET Core Configuration and also the use of encrypted values:</p>

<ul>
	<li><code>AddCommandLine</code>: to add the command line arguments.</li>	<li><code>AddJsonFile</code>: to add the <em>two json</em> files <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.ConsoleTest/appsettings.json"><em>appsetting.json</em></a> and <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.ConsoleTest/appsettings.development.json"><em>appsettings.development.json</em></a>, the second one has the <code>reloadOnChange</code> flag set to <code>true</code> in order to allow the reload of json file whenever it changes on the filesystem.
	<p>If you look at the <strong>ConnectionStrings section</strong> of <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.ConsoleTest/appsettings.json"><em>appsetting.json</em></a>, there are three keys:</p>

	<ul>
		<li><code>PlainTextConnectionString</code>: As the name states, it contains a plaintext connection string</li>		<li><code>PartiallyEncryptedConnectionString</code>: As the name states, it contains a mixture of plain text and multiple <code>Protect:{&lt;data to encrypt&gt;}</code> tokenization tags. On every run, these tokens get automatically encrypted and replaced with the <em><code>Protected:{&lt;encrypted data&gt;}</code></em> token after the call to the extension method <code>IProtectProviderConfigurationData.ProtectFiles.</code></li>		<li><code>FullyEncryptedConnectionString</code>: As the name states, it contains a single <code>Protect:{&lt;data to encrypt&gt;}</code> token spanning the whole connection string which gets totally encrypted after the first run.</li>	</ul>

	<p>If you look at <strong>Nullable section</strong> of <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.ConsoleTest/appsettings.development.json"><em>appsetting.development.json</em></a>, you can find some <strong>interesting keys</strong>:</p>

	<ul>
		<li><code>Int, DateTime, Double, Bool</code><i>: </i>These keys contain respectively an integer, a datetime, a double and a boolean but they are all stored as a <code>string</code> using a single <code>Protect:{&lt;data to encrypt&gt;}</code> tag<em>.</em> Hey wait, how is this possible?

		<p>Well, chiefly, all the <code>ConfigurationProviders</code> convert initially any <code>ConfigurationSource</code> into a <code>Dictionary&lt;String,String&gt;</code> in their <code>Load</code> method (please see the property <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationProvider.cs#L30">Data of the framework ConfigurationProvider base abstract class</a>, the <code>Load</code> method also flattens all the hierarchical path to the key into a <code>string</code> separated by a colon, so for example <code>Nullable-&gt;Int</code> becomes <code>Nullable:Int</code>). Only later, this dictionary gets converted and binded to a strongly typed class.</p>

		<p>The decryption process of <em><code>ProtectedConfigurationProvider</code></em> happens in the middle, so it's transparent for the user and moreover is available on any simple variable type (<code>DateTime</code>, <code>bool</code>, etc.). For now, the full encryption of a whole array is not supported, but you can however encrypt a single element converting the array to an array of strings (have a look at <code>DoubleArray</code> key, note also that in this key it is exemplified the use of per configuration value subkey, in fact the array contains twice the same <code>3.14</code> value [<code>"Protect:{3.14}"</code> and <code>"Protect:{%customSubPurpose%}:{3.14}"</code>] but it is encrypted with two different keys and different salt.</p>
		</li>	</ul>
	</li>	<li><code>AddXmlFile</code>: to add the XML file <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.ConsoleTest/appsettings.xml"><em>appsettings.xml</em></a></li>	<li><code>AddInMemoryCollection</code>: to add an in memory dictionary</li>	<li><code>AddEnvironmentVariables</code>: to add environment variables</li></ul>

<p>The main code of the <code>Protected.ConsoleTest</code> console application is:</p>

<div class="pre-lang" id="premain592233"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="592233" id="preShrink592233">Shrink ▲</span> &nbsp; <span id="copycode592233" class="copy-code" data-index="592233" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre592233" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-keyword">void</span> Main(String[] args)
{
&nbsp;&nbsp; &nbsp;args = <span class="code-keyword">new</span> String[] { <span class="code-string">"</span><span class="code-string">--EncryptedCommandLinePassword"</span>, <span class="code-string">"</span><span class="code-string">Protect:{secretArgPassword!\\*+?|{[()^$.#}"</span>, <span class="code-string">"</span><span class="code-string">--PlainTextCommandLinePassword"</span>, <span class="code-string">"</span><span class="code-string">secretArgPassword!\\*+?|{[()^$.#"</span> };

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> define the DI services: setup Data Protection API</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> servicesDataProtection = <span class="code-keyword">new</span> ServiceCollection();
&nbsp;&nbsp; &nbsp;ConfigureDataProtection(servicesDataProtection.AddDataProtection());
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> serviceProviderDataProtection = servicesDataProtection.BuildServiceProvider();


&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> creates all the DataProtectionAPIProtectConfigurationData classes specifying three different provider configurations</span>

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> standard configuration using key number purpose</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> standardProtectConfigurationData = <span class="code-keyword">new</span> DataProtectionAPIProtectConfigurationData(serviceProviderDataProtection);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> standard configuration using key number purpose overridden with a custom tokenization</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> otherProtectedTokenizationProtectConfigurationData = <span class="code-keyword">new</span> DataProtectionAPIProtectConfigurationData(serviceProviderDataProtection,<span class="code-digit">2</span>, protectRegexString: <span class="code-string">"</span><span class="code-string">OtherProtect(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectData&gt;.+?)}"</span>, protectedRegexString: <span class="code-string">"</span><span class="code-string">OtherProtected(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectedData&gt;.+?)}"</span>, protectedReplaceString: <span class="code-string">"</span><span class="code-string">OtherProtected${subPurposePattern}:{${protectedData}}"</span>);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> standard configuration using string purpose</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> magicPurposeStringProtectConfigurationData = <span class="code-keyword">new</span> DataProtectionAPIProtectConfigurationData(serviceProviderDataProtection, <span class="code-string">"</span><span class="code-string">MagicPurpose"</span>);&nbsp;



&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> activates JsonWithCommentsProtectFileProcessor</span>
&nbsp;&nbsp; &nbsp;ConfigurationBuilderExtensions.UseJsonWithCommentsProtectFileOption();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> define in-memory configuration key-value pairs to be encrypted</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> memoryConfiguration = <span class="code-keyword">new</span> Dictionary&lt;String, String&gt;
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">EncryptedInMemorySecretKey"</span>] = <span class="code-string">"</span><span class="code-string">Protect:{InMemory MyKey Value}"</span>,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">PlainTextInMemorySecretKey"</span>] = <span class="code-string">"</span><span class="code-string">InMemory MyKey Value"</span>,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">TransientFaultHandlingOptions:Enabled"</span>] = <span class="code-keyword">bool</span>.FalseString,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">Logging:LogLevel:Default"</span>] = <span class="code-string">"</span><span class="code-string">Protect:{Warning}"</span>,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">UserDomain"</span>] = <span class="code-string">"</span><span class="code-string">Protect:{DOMAIN\\USER}"</span>,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">EncryptedInMemorySpecialCharacters"</span>] = <span class="code-string">"</span><span class="code-string">Protect:{\\!*+?|{[()^$.#}"</span>,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[<span class="code-string">"</span><span class="code-string">PlainTextInMemorySpecialCharacters"</span>] = <span class="code-string">"</span><span class="code-string">\\!*+?|{[()^$.#"</span>
&nbsp;&nbsp; &nbsp;};

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> define an environment variable to be encrypted</span>
&nbsp;&nbsp; &nbsp;Environment.SetEnvironmentVariable(<span class="code-string">"</span><span class="code-string">EncryptedEnvironmentPassword"</span>, <span class="code-string">"</span><span class="code-string">Protect:{SecretEnvPassword\\!*+?|{[()^$.#}"</span>);
&nbsp;&nbsp; &nbsp;Environment.SetEnvironmentVariable(<span class="code-string">"</span><span class="code-string">PlainTextEnvironmentPassword"</span>, <span class="code-string">"</span><span class="code-string">SecretEnvPassword\\!*+?|{[()^$.#"</span>);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> encrypts all configuration sources (must be done before reading the configuration)</span>

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> encrypts all Protect:{&lt;data&gt;} token tags inside command line argument (you can use also the same method to encrypt String, IEnumerable&lt;String&gt;, IDictionary&lt;String,String&gt; value of any configuration source</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> encryptedArgs = standardProtectConfigurationData.ProtectConfigurationValue(args);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> encrypts all Protect:{&lt;data&gt;} token tags inside im-memory dictionary</span>
&nbsp;&nbsp; &nbsp;magicPurposeStringProtectConfigurationData.ProtectConfigurationValue(memoryConfiguration);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> encrypts all Protect:{&lt;data&gt;} token tags inside .json files and all OtherProtect:{&lt;data&gt;} inside .xml files&nbsp;</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> encryptedJsonFiles = standardProtectConfigurationData.ProtectFiles(<span class="code-string">"</span><span class="code-string">."</span>);
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> encryptedXmlFiles = otherProtectedTokenizationProtectConfigurationData.ProtectFiles(<span class="code-string">"</span><span class="code-string">."</span>, searchPattern: <span class="code-string">"</span><span class="code-string">*.xml"</span>);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> encrypts all Protect:{&lt;data&gt;} token tags inside environment variables</span>
&nbsp;&nbsp; &nbsp;magicPurposeStringProtectConfigurationData.ProtectEnvironmentVariables();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> please check that all configuration source defined above are encrypted (check also Environment.GetEnvironmentVariable("SecretEnvironmentPassword") in Watch window)</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> note the per key purpose string override in file appsettings.development.json inside Nullable:DoubleArray contains two elements one with "Protect:{3.14}" and one with "Protect:{%customSubPurpose%}:{3.14}", even though the value is the same (3.14) they are encrypted differently due to the custom key purpose string</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> note the per key purpose string override in file appsettings.xml inside TransientFaultHandlingOptions contains two elements AutoRetryDelay with "OtherProtect:{00:00:07}" and AutoRetryDelaySubPurpose with "OtherProtect:{sUbPuRpOsE}:{00:00:07}", even though the value is the same (00:00:07) they are encrypted differently due to the custom key purpose string</span>
&nbsp;&nbsp; &nbsp;Debugger.Break();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> define the application configuration using almost all possible known ConfigurationSources</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> configuration = <span class="code-keyword">new</span> ProtectedConfigurationBuilder(standardProtectConfigurationData) &nbsp;<span class="code-comment">//</span><span class="code-comment"> global configuration</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddCommandLine(encryptedArgs)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddJsonFile(<span class="code-string">"</span><span class="code-string">appsettings.json"</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddJsonFile($<span class="code-string">"</span><span class="code-string">appsettings.{Environment.GetEnvironmentVariable("</span>DOTNETCORE_ENVIRONMENT<span class="code-string">"</span><span class="code-string">)}.json"</span>, <span class="code-keyword">false</span>, <span class="code-keyword">true</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddXmlFile(<span class="code-string">"</span><span class="code-string">appsettings.xml"</span>).WithProtectedConfigurationOptions(otherProtectedTokenizationProtectConfigurationData) <span class="code-comment">//</span><span class="code-comment"> overrides global configuration for XML file</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddInMemoryCollection(memoryConfiguration).WithProtectedConfigurationOptions(magicPurposeStringProtectConfigurationData) <span class="code-comment">//</span><span class="code-comment"> overrides global configuration for in-memory collection file</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.AddEnvironmentVariables().WithProtectedConfigurationOptions(magicPurposeStringProtectConfigurationData) <span class="code-comment">//</span><span class="code-comment"> overrides global configuration for enviroment variables file</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;.Build();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> define other DI services: configure strongly typed AppSettings configuration class (must be done after having read the configuration)</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> services = <span class="code-keyword">new</span> ServiceCollection();
&nbsp;&nbsp; &nbsp;services.Configure&lt;AppSettings&gt;(configuration);
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> serviceProvider = services.BuildServiceProvider();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> retrieve the strongly typed AppSettings configuration class, we use IOptionsMonitor in order to be notified on any reloads of appSettings</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> optionsMonitor = serviceProvider.GetRequiredService&lt;IOptionsMonitor&lt;AppSettings&gt;&gt;();
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> appSettings = optionsMonitor.CurrentValue;
&nbsp;&nbsp; &nbsp;optionsMonitor.OnChange(appSettingsReloaded =&gt;
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> this breakpoint gets hit when the appsettings have changed due to a configuration reload, please check that the value of "Int" property inside appSettingsReloaded class is different from the one inside appSettings class</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> note that also there is an unavoidable framework bug on ChangeToken.OnChange which could get called multiple times when using FileSystemWatchers see https://github.com/dotnet/aspnetcore/issues/2542</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> see also the remarks section of FileSystemWatcher https://learn.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher.created?view=net-8.0#remarks</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Console.WriteLine($<span class="code-string">"</span><span class="code-string">OnChangeEvent: appsettings.{Environment.GetEnvironmentVariable("</span>DOTNETCORE_ENVIRONMENT<span class="code-string">"</span><span class="code-string">)}.json has been reloaded! appSettings Int {appSettings.Int} appSettingsReloaded {appSettingsReloaded.Int}"</span>);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debugger.Break();
&nbsp;&nbsp; &nbsp;});

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> please check that all values inside appSettings class are actually decrypted with the right value, make a note of the value of "Int" property it will change on the next second breakpoint</span>
&nbsp;&nbsp; &nbsp;Debugger.Break();

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> added some simple assertions to test that decrypted value is the same as original plaintext one</span>
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.EncryptedCommandLinePassword == appSettings.PlainTextCommandLinePassword);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.EncryptedEnvironmentPassword == appSettings.PlainTextEnvironmentPassword);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.EncryptedInMemorySecretKey == appSettings.PlainTextInMemorySecretKey);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> appsettings.json assertions</span>
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.EncryptedJsonSpecialCharacters == appSettings.PlainTextJsonSpecialCharacters);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.ConnectionStrings[<span class="code-string">"</span><span class="code-string">PartiallyEncryptedConnectionString"</span>].Contains(<span class="code-string">"</span><span class="code-string">(local)\\SECONDINSTANCE"</span>));
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.ConnectionStrings[<span class="code-string">"</span><span class="code-string">PartiallyEncryptedConnectionString"</span>].Contains(<span class="code-string">"</span><span class="code-string">Secret_Catalog"</span>));
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.ConnectionStrings[<span class="code-string">"</span><span class="code-string">PartiallyEncryptedConnectionString"</span>].Contains(<span class="code-string">"</span><span class="code-string">secret_user"</span>));
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.ConnectionStrings[<span class="code-string">"</span><span class="code-string">PartiallyEncryptedConnectionString"</span>].Contains(<span class="code-string">"</span><span class="code-string">secret_password"</span>));
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.ConnectionStrings[<span class="code-string">"</span><span class="code-string">FullyEncryptedConnectionString"</span>].Contains(<span class="code-string">"</span><span class="code-string">Data Source=server1\\THIRDINSTANCE; Initial Catalog=DB name; User ID=sa; Password=pass5678; MultipleActiveResultSets=True;"</span>));

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> appsettings.development.json assertions</span>
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.DateTime.Value.ToUniversalTime() == <span class="code-keyword">new</span> DateTime(<span class="code-digit">2016</span>, <span class="code-digit">10</span>, <span class="code-digit">1</span>, <span class="code-digit">20</span>, <span class="code-digit">34</span>, <span class="code-digit">56</span>, <span class="code-digit">789</span>, DateTimeKind.Utc));
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.<span class="code-sdkkeyword">Double</span> == <span class="code-digit">123</span>.<span class="code-digit">456</span>);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.Int == <span class="code-digit">98765</span>);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.Bool == <span class="code-keyword">true</span>);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.DoubleArray[1] == <span class="code-digit">3</span>.<span class="code-digit">14</span>);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Nullable.DoubleArray[3] == <span class="code-digit">3</span>.<span class="code-digit">14</span>);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> appsettings.xml assertions</span>
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.TransientFaultHandlingOptions[<span class="code-string">"</span><span class="code-string">AutoRetryDelay"</span>] == appSettings.TransientFaultHandlingOptions[<span class="code-string">"</span><span class="code-string">AutoRetryDelaySubPurpose"</span>]);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.Logging.LogLevel[<span class="code-string">"</span><span class="code-string">Microsoft"</span>] == <span class="code-string">"</span><span class="code-string">Warning"</span>);
&nbsp;&nbsp; &nbsp;Debug.Assert(appSettings.EncryptedXmlSecretKey == appSettings.PlainTextXmlSecretKey);


&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> multiple configuration reload example (in order to check that the ReloadToken re-registration works)</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">int</span> i = <span class="code-digit">0</span>;
&nbsp;&nbsp; &nbsp;<span class="code-keyword">while</span> (i++ &lt; <span class="code-digit">5</span>)
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> updates inside appsettings.&lt;environment&gt;.json the property "Int": &lt;whatever&gt;, --&gt; "Int": "Protected:{&lt;random number&gt;},"</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> environmentAppSettings = File.ReadAllText($<span class="code-string">"</span><span class="code-string">appsettings.{Environment.GetEnvironmentVariable("</span>DOTNETCORE_ENVIRONMENT<span class="code-string">"</span><span class="code-string">)}.json"</span>);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;environmentAppSettings = <span class="code-keyword">new</span> Regex(<span class="code-string">"</span><span class="code-string">\"Int\":.+?,"</span>).Replace(environmentAppSettings, $<span class="code-string">"</span><span class="code-string">\"Int\": \"{standardProtectConfigurationData.ProtectConfigurationValue($"</span>Protect:{{{<span class="code-keyword">new</span> Random().Next(<span class="code-digit">0</span>, <span class="code-digit">1000000</span>)}}}<span class="code-string">"</span><span class="code-string">)}\","</span>);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;File.WriteAllText($<span class="code-string">"</span><span class="code-string">appsettings.{Environment.GetEnvironmentVariable("</span>DOTNETCORE_ENVIRONMENT<span class="code-string">"</span><span class="code-string">)}.json"</span>, environmentAppSettings);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> wait 5 seconds for the reload to take place, please check on this breakpoint that the value of "Int" property has changed in appSettings class and it is the same of appSettingsReloaded</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Thread.Sleep(<span class="code-digit">5000</span>);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;appSettings = optionsMonitor.CurrentValue;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Console.WriteLine($<span class="code-string">"</span><span class="code-string">ConfigurationReloadLoop: appSettings Int {appSettings.Int}"</span>);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debugger.Break();
&nbsp;&nbsp; &nbsp;}
}</pre>

<p>The above code is quite simple and commented, if you launch it in Debug mode, it will automatically break into most significant points by using <code>Debugger.Break()</code>:</p>

<ul>
	<li>The first one happens after all six configuration sources values have been encrypted by replacing the default tokenization tag <code>Protect:{&lt;data to encrypt&gt;}</code> with <code>Protected:{&lt;encrypted data&gt;}</code> (for files, please check those inside <em>bin/Debug/net6.0</em> folder and not inside the solution <em>dir</em> which remain unchanged)

	<ul>
		<li><em><strong>CommandLine arguments</strong></em> <code>args</code> gets encrypted in <code>encryptedArgs</code> variable by using the provided extension method <code>IProtectProviderConfigurationData.ProtectConfigurationValue</code></li>		<li>The <strong><em>appsettings.*json</em></strong> files have been backed up in a <em>.bak</em> file and encrypted by using the provided extension method <code>IProtectProviderConfigurationData.ProtectFiles</code></li>		<li>The <em><strong>appsettings.xml</strong></em> file has been backed up in a <em>.bak</em> file and has been encrypted by using the provided extension method <code>IProtectProviderConfigurationData.ProtectFiles</code></li>		<li>The <em><strong>environment variables</strong></em> have got encrypted by using <code>IProtectProviderConfigurationData.ProtectEnvironmentVariables</code></li>	</ul>
	</li>	<li>The second one is the one actually showing the use of <code>ProtectedConfigurationBuilder</code>, if you watch in the debugger the <code>appSettings</code> strongly typed class, you will notice that it magically and automatically contains the decrypted values with the right data type even though the encrypted keys are always stored in configuration sources as <code>strings</code>. Please note that I used <code>IOptionsMonitor&lt;AppSettings&gt;</code> instead <code>IOptions&lt;AppSettings&gt;</code> because I wanted to test also the autodecryption feature on reload of a configuration file whenever it changes on filesystem.<br>
	&nbsp;</li>	<li>The third one, the fith one, the seventh one, etc. is inside the <code>IOptionsMonitor.OnChange</code> event and happens just after having updated the "<code>Int</code>" property with a random encrypted integer inside <em>appsettings.development.json</em> file (take note of this value, you will need it again in the next breakpoint), you can see that the <code>appSettingsReloaded</code> variable contains a different value from the one of <code>appSettings</code> variable.<br>
	&nbsp;</li>	<li>The fourth one, the sixth one, the eighth one, etc. is after <code>IOptionsMonitor.OnChange</code> event and happens after re-assignment to <code>appSettings</code> variable of the current strongly typed configuration class from <code>IOptionsMonitor</code>, you can check that <code>appSettings</code> contains the same new value for "<code>Int</code>" property as that of <code>appSettingsReloaded</code> variable at previous breakpoint.</li></ul>

<p><strong>So summing up in order to use this package, we had just to use to replace the call </strong><code><strong>new ConfigurationBuilder()</strong></code><strong> with a call to </strong><code><strong>new ProtectedConfigurationBuilder()</strong></code><strong>, pass the Data Protection API configuration and an eventual custom tokenization tag, and everything works flawlessly in a transparent way. Moreover, all the decryption happens in memory and nothing is stored on disk for any reason.</strong></p>

<h2>Implementation Details</h2>

<p>I explain here the main points of the implementation:</p>

<h3 id="PointsOfInterest">Code inside Fededim.Extensions.Configuration.Protected package</h3>

<ul>
	<li>Extensions methods defined inside <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ConfigurationBuilderExtensions.cs"><code>ConfigurationBuilderExtensions</code></a>:

	<ul>
		<li><code>ProtectFiles</code> is an extension method of <code>IProtectProviderConfigurationData&nbsp;</code>which gets called and scans all files according to the supplied extension <code>searchPattern</code> inside the supplied <code>path</code> for <code>Protect:{&lt;data to encrypt&gt;}</code> tokens, encrypts enclosed data, performs the replacement with <code>Protected:{&lt;encrypted data&gt;}</code> and saves back the file after having created an optional backup of the original file with the <em>.bak</em> extension. Again, if you do not like the default tokenization regular expression, you can pass your own one with the constraint that it must extract the <code>&lt;data to encrypt&gt;</code> substring in a group called <code>protectData</code> and optionally the &lt;<code>subPurposePattern&gt;</code> and <code>&lt;subPurpose&gt; </code>substrings in two groups called respectively <code>subPurposePattern</code> and <code>subPurpose.</code></li>	</ul>
	</li></ul>

<div class="pre-lang" id="premain352239"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="352239" id="preShrink352239">Shrink ▲</span> &nbsp; <span id="copycode352239" class="copy-code" data-index="352239" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre352239" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Perform wildcard search of files in path encrypting any data using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="path"</span><span class="code-summarycomment">&gt;</span>directory to be searched<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="searchPattern"</span><span class="code-summarycomment">&gt;</span>wildcard pattern to filter files<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="searchOption"</span><span class="code-summarycomment">&gt;</span>search options<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="backupOriginalFile"</span><span class="code-summarycomment">&gt;</span>boolean which indicates whether to make a backupof original file with extension .bak<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a list of filenames which have been successfully encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">exception</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ArgumentException"</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/exception</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> IList&lt;String&gt; ProtectFiles(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, <span class="code-sdkkeyword">String</span> path, <span class="code-sdkkeyword">String</span> searchPattern = <span class="code-string">"</span><span class="code-string">*.json"</span>, SearchOption searchOption = SearchOption.TopDirectoryOnly, <span class="code-keyword">bool</span> backupOriginalFile = <span class="code-keyword">true</span>)
{
&nbsp;&nbsp; &nbsp;protectProviderConfigurationData.CheckConfigurationIsValid();

&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> result = <span class="code-keyword">new</span> List&lt;String&gt;();

&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> f <span class="code-keyword">in</span> Directory.EnumerateFiles(path, searchPattern, searchOption))
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> fileContent = File.ReadAllText(f);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> replacedContent = fileContent;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> protectFileOption <span class="code-keyword">in</span> ProtectFilesOptions)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (protectFileOption.FilenameRegex.Match(f).Success)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;replacedContent = protectFileOption.ProtectFileProcessor.ProtectFile(fileContent, protectProviderConfigurationData.ProtectRegex, (<span class="code-sdkkeyword">value</span>) =&gt; ProtectConfigurationValue(protectProviderConfigurationData, <span class="code-sdkkeyword">value</span>));
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">break</span>;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (replacedContent != fileContent)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (backupOriginalFile)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;File.Copy(f, f + <span class="code-string">"</span><span class="code-string">.bak"</span>, <span class="code-keyword">true</span>);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;File.WriteAllText(f, replacedContent);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result.Add(f);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;}

&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> result;
}</pre>

<p style="margin-left: 80px">The format of input files is decoded, encrypted and re-encoded according to the processor specified in the public static property <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ConfigurationBuilderExtensions.cs#L15-L48"><code>ConfigurationBuilderExtensions.ProtectFilesOptions</code></a>,<font color="#990000" face="Consolas, monospace, mono"><span style="font-size: 15px"> </span></font>by default three processors are provided, two&nbsp;for <strong>JSON </strong>files (e.g. \\ becomes \, etc., see <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectFileProcessors.cs#L78-L180"><code>JsonProtectFileProcessor </code></a>and <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectFileProcessors.cs#L184-L234"><code>JsonWithCommentsProtectFileProcessor&nbsp;</code></a>class in <code>ProtectFileProcessors.cs</code>) and one for <strong>XML </strong>files (e.g. &amp;gt; becomes &gt;, etc., see <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectFileProcessors.cs#L238-L321"><code>XmlProtectFileProcessor </code></a>class again in <code>ProtectFileProcessors.cs</code>) and one for <strong>RAW text files</strong> (no decoding is done, see <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectFileProcessors.cs#L56-L74"><code>RawProtectFileProcessor </code></a>class again in <code>ProtectFileProcessors.cs</code>). You can add as many processors as you wish by adding records to the <code>ConfigurationBuilderExtensions.ProtectFilesOptions&nbsp;</code>list specifying a <code>filenameRegex </code>which if matched applies the associated <code>ProtectFileProcessor</code>, e.g. a class which must implement the <code>IProtectFileProcessor </code>interface (see below). This interface has essentially just one method <code>ProtectFile </code>which essentially takes in input 3 parameters passed to it by the <code>ConfigurationBuilderExtensions.ProtectFiles</code> method:</p>

<ul>
	<li style="margin-left: 80px"><code>rawFileText</code>: this is the raw input file as a string</li>	<li style="margin-left: 80px"><code>protectRegex</code>: this is the configured protected regex which must be matched in file configuration values in order to choose whether to encrypt or not the data.</li>	<li style="margin-left: 80px"><code>protectFunction: </code>this is the protect function which encrypts data taking the plaintext data as input and producing encrypted base64 string as output.</li></ul>

<p style="margin-left: 80px">This <code>ProtectFile </code>method must decode, encrypt and re-encode the input file and return it as a string as final output. Note that all the file processors are processed in <strong><em>FIFO (First-In First-Out)</em></strong> order so keep this in mind when configuring your additional handlers.</p>

<div class="pre-lang" id="premain408125"><div>C#</div><div class="pre-action-link"><span id="copycode408125" class="copy-code" data-index="408125" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre408125" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> This is the interface which must be implemented by a custom ProtectFileProcessor. It contains a single method <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ProtectFile"/</span><span class="code-summarycomment">&gt;</span> used to decode, encrypt and re-encode the input file and return it as string.
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">interface</span> IProtectFileProcessor
{
    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> This method actually implements a custom ProtectFileProcessor which must decode, encrypt and re-encode the input file and return it as string.
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="rawFileText"</span><span class="code-summarycomment">&gt;</span>The is the raw input file as a string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectRegex"</span><span class="code-summarycomment">&gt;</span>This is the configured protected regex which must be matched in file values in order to choose whether to encrypt or not the data.<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectFunction"</span><span class="code-summarycomment">&gt;</span>This is the protect function taking the plaintext data as input and producing encrypted base64 data as output<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the encrypted re-encoded file as a string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-sdkkeyword">String</span> ProtectFile(<span class="code-sdkkeyword">String</span> rawFileText, Regex protectRegex, Func&lt;String, String&gt; protectFunction);
}</pre>

<ul style="margin-left: 40px">
	<li><code>ProtectEnvironmentVariables</code> is an extension method of <code>IProtectProviderConfigurationData&nbsp;</code>which encrypts the environment variables with the same criteria.

	<div class="pre-lang" id="premain992680"><div>C#</div><div class="pre-action-link"><span id="copycode992680" class="copy-code" data-index="992680" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre992680" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Encrypts all the environment variables using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span> (used for environment variables)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-keyword">void</span> ProtectEnvironmentVariables(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, EnvironmentVariableTarget environmentTarget = EnvironmentVariableTarget.User)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> environmentVariables = Environment.GetEnvironmentVariables(environmentTarget);

&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-sdkkeyword">String</span> key <span class="code-keyword">in</span> environmentVariables.Keys)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Environment.SetEnvironmentVariable(key, protectProviderConfigurationData.ProtectConfigurationValue(environmentVariables[key].ToString()));
}</pre>
	</li>	<li><code>ProtectConfigurationValue</code> is an extension method of <code>IProtectProviderConfigurationData&nbsp;</code>which encrypts a <code>string</code>, an <code>IEnumerable&lt;string&gt;</code>, a <code>string[]</code> or a <code>Dictionary&lt;string,string&gt;</code> with the same criteria. The ultimate method responsible for the actual encryption is <code>ProtectConfigurationValueInternal</code> (it is the only private method since static classes do not have protected members)</li></ul>

<div class="pre-lang" id="premain33560"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="33560" id="preShrink33560">Shrink ▲</span> &nbsp; <span id="copycode33560" class="copy-code" data-index="33560" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre33560" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Encrypts the String value using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="value"</span><span class="code-summarycomment">&gt;</span>a String literal which needs to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the encrypted configuration value<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">exception</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ArgumentException"</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/exception</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-sdkkeyword">String</span> ProtectConfigurationValue(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, <span class="code-sdkkeyword">String</span> <span class="code-sdkkeyword">value</span>)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> ProtectConfigurationValueInternal(protectProviderConfigurationData, <span class="code-sdkkeyword">value</span>);
}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> internal method actually performing the encryption using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="value"</span><span class="code-summarycomment">&gt;</span>a String literal which needs to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">private</span> <span class="code-keyword">static</span> <span class="code-sdkkeyword">String</span> ProtectConfigurationValueInternal(IProtectProviderConfigurationData protectProviderConfigurationData, <span class="code-sdkkeyword">String</span> <span class="code-sdkkeyword">value</span>)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (<span class="code-sdkkeyword">value</span> == <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> <span class="code-keyword">null</span>;

&nbsp;&nbsp; &nbsp;protectProviderConfigurationData.CheckConfigurationIsValid();

&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> protectProviderConfigurationData.ProtectRegex.Replace(<span class="code-sdkkeyword">value</span>, (me) =&gt;
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> subPurposePresent = !String.IsNullOrEmpty(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>]?.Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> protectProvider = protectProviderConfigurationData.ProtectProvider;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (subPurposePresent)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;protectProvider = protectProviderConfigurationData.ProtectProvider.CreateNewProviderFromSubkey(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>].Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> protectProviderConfigurationData.ProtectedReplaceString.Replace(<span class="code-string">"</span><span class="code-string">${subPurposePattern}"</span>, subPurposePresent ? me.Groups[<span class="code-string">"</span><span class="code-string">subPurposePattern"</span>].Value : <span class="code-sdkkeyword">String</span>.Empty).Replace(<span class="code-string">"</span><span class="code-string">${protectedData}"</span>, protectProvider.Encrypt(me.Groups[<span class="code-string">"</span><span class="code-string">protectData"</span>].Value));
&nbsp;&nbsp; &nbsp;});
}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Encrypts the Dictionary<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">String,</span><span class="code-summarycomment"> </span><span class="code-summarycomment">String</span><span class="code-summarycomment">&gt;</span> initialData using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span> (used for in-memory collections)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="initialData"</span><span class="code-summarycomment">&gt;</span>a Dictionary<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">String,</span><span class="code-summarycomment"> </span><span class="code-summarycomment">String</span><span class="code-summarycomment">&gt;</span> whose values need to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-keyword">void</span> ProtectConfigurationValue(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, Dictionary&lt;String, String&gt; initialData)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (initialData != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> key <span class="code-keyword">in</span> initialData.Keys.ToList())
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;initialData[key] = protectProviderConfigurationData.ProtectConfigurationValue(initialData[key]);
}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Encrypts the IEnumerable<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">String</span><span class="code-summarycomment">&gt;</span> arguments using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="arguments"</span><span class="code-summarycomment">&gt;</span>a IEnumerable<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">String</span><span class="code-summarycomment">&gt;</span> whose elements need to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a newer encrypted IEnumerable<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">String</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> IEnumerable&lt;String&gt; ProtectConfigurationValue(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, IEnumerable&lt;String&gt; arguments)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> arguments?.Select(argument =&gt; protectProviderConfigurationData.ProtectConfigurationValue(argument));
}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Encrypts the String[] arguments using the specified <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="protectProviderConfigurationData"/</span><span class="code-summarycomment">&gt;</span> (used for command-line arguments)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderConfigurationData"</span><span class="code-summarycomment">&gt;</span>an IProtectProviderConfigurationData interface obtained from a one of the supported providers<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="arguments"</span><span class="code-summarycomment">&gt;</span>a String array whose elements need to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a newer encrypted String[] array<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> String[] ProtectConfigurationValue(<span class="code-keyword">this</span> IProtectProviderConfigurationData protectProviderConfigurationData, String[] arguments)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> arguments?.Select(argument =&gt; protectProviderConfigurationData.ProtectConfigurationValue(argument)).ToArray();
}</pre>

<ul style="margin-left: 40px">
	<li><code>WithProtectedConfigurationOptions:</code>&nbsp;It is an extension method of <code>IConfigurationBuilder </code>which allows to override the Data Protection or tokenization tag configuration for a particular <code>ConfigurationSource</code> (e.g., the last one added). Note that this method is a little bit hacky: I was not able to change the return type of <code>ProtectedConfigurationBuilder.Add</code>, otherwise the <code>IConfigurationBuilder</code> interface wouldn't be implemented; thus <code>WithProtectedConfigurationOptions</code> extends the standard <code>IConfigurationBuilder</code> interface and converts it to <code>IProtectedConfigurationBuilder</code> interface and calls the <code>ProtectedConfigurationBuilder.WithProtectedConfigurationOptions</code> method, if instead the provided <code>IConfigurationBuilder</code> is not an instance of<code> IProtectedConfigurationBuilder</code>&nbsp;it raises an exception remembering to replace the <code>new ConfigurationBuilder</code> instantiation with new <code>ProtectedConfigurationBuilder</code>. This method takes as input just one parameter: a&nbsp;<code>IProtectProviderConfigurationData</code>&nbsp;class configured properly which overrides the global configuration specified in the <code>ProtectedConfigurationBuilder </code>constructor.

	<div class="pre-lang" id="premain996704"><div>C#</div><div class="pre-action-link"><span id="copycode996704" class="copy-code" data-index="996704" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre996704" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> WithProtectedConfigurationOptions is a helper method used to override the ProtectedGlobalConfigurationData for a particular provider (e.g. the last one added)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="configurationBuilder"</span><span class="code-summarycomment">&gt;</span>the IConfigurationBuilder instance<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectProviderLocalConfigurationData"</span><span class="code-summarycomment">&gt;</span>a regular expression which captures the data to be decrypted in a named group called protectedData<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>The <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IConfigurationBuilder"/</span><span class="code-summarycomment">&gt;</span> interface for method chaining<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">exception</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ArgumentException"</span><span class="code-summarycomment">&gt;</span>if configurationBuilder is not an instance of ProtectedConfigurationBuilder class<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/exception</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> IConfigurationBuilder WithProtectedConfigurationOptions(<span class="code-keyword">this</span> IConfigurationBuilder configurationBuilder, IProtectProviderConfigurationData protectProviderLocalConfigurationData)
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> protectedConfigurationBuilder = configurationBuilder <span class="code-keyword">as</span> IProtectedConfigurationBuilder;

&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (protectedConfigurationBuilder != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> protectedConfigurationBuilder.WithProtectedConfigurationOptions(protectProviderLocalConfigurationData);
&nbsp;&nbsp; &nbsp;<span class="code-keyword">else</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">Please use ProtectedConfigurationBuilder instead of ConfigurationBuilder class!"</span>, <span class="code-keyword">nameof</span>(configurationBuilder));

}</pre>
	</li></ul>

<ul>
	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectedConfigurationBuilder.cs"><code>ProtectedConfigurationBuilder</code> </a>implements the <code>IConfigurationBuilder</code> interface like <code>ConfigurationBuilder</code> framework class (from which part of the implementation is borrowed), the main difference is the <code>Build</code> method which elementally <strong>proxies through composition </strong>the <code>IConfigurationProvider</code> returned from the <code>IConfigurationSource.Build</code> method by passing it as a constructor parameter to the core class responsible for in memory transparent decryption: <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectedConfigurationProvider.cs"><code>ProtectedConfigurationProvider</code></a>. It also performs the merge between the custom configuration specified for the <code>IConfigurationSource</code> being converted into <code>IConfigurationProvider</code> (if you want to know how, check the <a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectProviderConfigurationData.cs#L123-L142"><code>ProtectProviderConfigurationData.Merge</code></a> <code>static</code> method) and the global configuration specified in the <code>ProtectedConfigurationBuilder</code> constructor.</li></ul>

<div class="pre-lang" id="premain180245"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="180245" id="preShrink180245">Shrink ▲</span> &nbsp; <span id="copycode180245" class="copy-code" data-index="180245" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre180245" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Builds an <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IConfiguration"/</span><span class="code-summarycomment">&gt;</span> with keys and values from the set of configuration sources registered in <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="Sources"/</span><span class="code-summarycomment">&gt;</span>.
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>An <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IConfigurationRoot"/</span><span class="code-summarycomment">&gt;</span> with keys and values from the providers generated by registered configuration sources.<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">virtual</span> IConfigurationRoot Build()
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> providers = <span class="code-keyword">new</span> List&lt;IConfigurationProvider&gt;();
&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (IConfigurationSource source <span class="code-keyword">in</span> _sources)
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IConfigurationProvider provider = source.Build(<span class="code-keyword">this</span>);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> if we have a custom configuration we move the index from the ConfigurationSource object to the newly created ConfigurationProvider object</span>
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectProviderLocalConfigurationData.TryGetValue(source.GetHashCode(), <span class="code-keyword">out</span> <span class="code-keyword">var</span> protectedConfigurationData);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (protectedConfigurationData != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectProviderLocalConfigurationData[provider.GetHashCode()] = protectedConfigurationData;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectProviderLocalConfigurationData.Remove(source.GetHashCode());
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;providers.Add(CreateProtectedConfigurationProvider(provider));
&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> <span class="code-keyword">new</span> ConfigurationRoot(providers);
}




<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> CreateProtectedConfigurationProvider creates a new ProtectedConfigurationProvider using the composition approach
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="provider"</span><span class="code-summarycomment">&gt;</span>an existing IConfigurationProvider to instrument in order to perform the decryption of the encrypted keys<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a newer decrypted <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IConfigurationProvider"/</span><span class="code-summarycomment">&gt;</span> if we have a valid protected configuration data, otherwise it returns the existing original undecrypted provider<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">protected</span> <span class="code-keyword">virtual</span> IConfigurationProvider CreateProtectedConfigurationProvider(IConfigurationProvider provider)
{
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> this code is an initial one of when I was thinking of casting IConfigurationProvider to ConfigurationProvider (all MS classes derive from this one)</span>
&nbsp; &nbsp; <span class="code-comment">//</span><span class="code-comment"> in order to retrieve all configuration keys inside DecryptChildKeys using the Data property (through reflection since it is protected) without using the recursive "hack" of GetChildKeys&nbsp;</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> it has been commented because it is not needed anymore, but I keep it as workaround for accessing all configuration keys just in case MS changes the implementation of GetChildKeys "forbidding" the actual way</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment">var providerType = provider.GetType();</span>

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment">if (!providerType.IsSubclassOf(typeof(ConfigurationProvider)))</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> &nbsp; &nbsp;return provider;</span>

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> we merge ProtectedProviderGlobalConfigurationData and ProtectProviderLocalConfigurationData</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> actualProtectedConfigurationData = ProtectProviderLocalConfigurationData.ContainsKey(provider.GetHashCode()) ? ProtectProviderConfigurationData.Merge(ProtectedProviderGlobalConfigurationData, ProtectProviderLocalConfigurationData[provider.GetHashCode()]) : ProtectedProviderGlobalConfigurationData;

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> we use composition to perform decryption of all provider values</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> <span class="code-keyword">new</span> ProtectedConfigurationProvider(provider, actualProtectedConfigurationData);
}</pre>

<ul class="method">
	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectProviderConfigurationData.cs#L38-L90">IProtectProviderConfigurationData</a> This class is an abstract class for specifying the configuration options and plugging the providers into <code>ProtectedConfigurationBuilder. </code>

	<div class="pre-lang" id="premain818686"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="818686" id="preShrink818686">Shrink ▲</span> &nbsp; <span id="copycode818686" class="copy-code" data-index="818686" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre818686" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> an abstract class for specifying the configuration data of the encryption/decryption provider
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">abstract</span> <span class="code-keyword">class</span> IProtectProviderConfigurationData
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectRegexString = <span class="code-string">"</span><span class="code-string">Protect(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectData&gt;.*?)}"</span>;
&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedRegexString = <span class="code-string">"</span><span class="code-string">Protected(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectedData&gt;.*?)}"</span>;
&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedReplaceString = <span class="code-string">"</span><span class="code-string">Protected${subPurposePattern}:{${protectedData}}"</span>;

&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> The actual provider performing the encryption/decryption, <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> interface
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> IProtectProvider ProtectProvider { <span class="code-keyword">get</span>; <span class="code-keyword">protected</span> <span class="code-keyword">set</span>; }

&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> a regular expression which captures the data to be decrypted in a named group called protectData
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> Regex ProtectedRegex { <span class="code-keyword">get</span>; <span class="code-keyword">protected</span> <span class="code-keyword">set</span>; }


&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> a regular expression which captures the data to be encrypted in a named group called protectData
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> Regex ProtectRegex { <span class="code-keyword">get</span>; <span class="code-keyword">protected</span> <span class="code-keyword">set</span>; }


&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> a string replacement expression which captures the substitution which must be applied for transforming unencrypted tokenization <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="DefaultProtectRegexString"</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span> into an encrypted tokenization <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="DefaultProtectedRegexString"</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> <span class="code-sdkkeyword">String</span> ProtectedReplaceString { <span class="code-keyword">get</span>; <span class="code-keyword">protected</span> <span class="code-keyword">set</span>; }


&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> A helper overridable method for checking that the configuation data is valid (e.g. ProtectProvider is not null, ProtectedRegex and ProtectRegex contains both a regex group named protectedData)&nbsp;
</span>&nbsp;&nbsp; &nbsp;<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>&nbsp;&nbsp; &nbsp;<span class="code-keyword">public</span> <span class="code-keyword">virtual</span> <span class="code-keyword">void</span> CheckConfigurationIsValid()
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectRegex = ProtectRegex ?? <span class="code-keyword">new</span> Regex(DefaultProtectRegexString);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!ProtectRegex.GetGroupNames().Contains(<span class="code-string">"</span><span class="code-string">protectData"</span>))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">ProtectRegex must contain a group named protectedData!"</span>, <span class="code-keyword">nameof</span>(ProtectRegex));

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectedRegex = ProtectedRegex ?? <span class="code-keyword">new</span> Regex(DefaultProtectedRegexString);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!ProtectedRegex.GetGroupNames().Contains(<span class="code-string">"</span><span class="code-string">protectedData"</span>))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">ProtectedRegex must contain a group named protectedData!"</span>, <span class="code-keyword">nameof</span>(ProtectedRegex));

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectedReplaceString = !String.IsNullOrEmpty(ProtectedReplaceString) ? ProtectedReplaceString : DefaultProtectedReplaceString;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!ProtectedReplaceString.Contains(<span class="code-string">"</span><span class="code-string">${protectedData}"</span>))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">ProtectedReplaceString must contain ${protectedData}!"</span>, <span class="code-keyword">nameof</span>(ProtectedReplaceString));

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (ProtectProvider == <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">ProtectProvider must not be null!"</span>, <span class="code-keyword">nameof</span>(ProtectProvider));
&nbsp;&nbsp; &nbsp;}
}</pre>

	<p>As we can see the <code>IProtectProviderConfigurationData</code> fundamentally contains four properties and one method:</p>

	<ul>
		<li><code>ProtectedRegex</code>: It is a regular expression which specifies the tokenization tag which encloses the encrypted data to be decrypted; it must define a named group called <code>protectedData </code>(and optionally two additional groups called <code>subPurposePattern </code>and <code>subPurpose </code>for specifying a per configuration value subkey). If <code>null</code>, this parameter assumes the default value:

		<div class="pre-lang" id="premain673709"><div>C#</div><div class="pre-action-link"><span id="copycode673709" class="copy-code" data-index="673709" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre673709" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedRegexString = <span class="code-string">"</span><span class="code-string">Protected(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectedData&gt;.*?)}"</span>;</pre>

		<p>The above regular expression essentially searches in a lazy way (so it can retrieve all the occurrences inside a value) for any <code>string</code> matching the pattern <code>'Protected:{&lt;subPurpose&gt;}:{&lt;encrypted data&gt;}'</code> and extracts the <code>&lt;encrypted data&gt;</code> substring storing it inside a group named <code>protectedData</code>. There is also an <strong>optional </strong>part called &lt;<code>subPurposePattern&gt;</code> (made up of<code> :{&lt;subPurpose&gt;}</code>)<code> </code>which allows to specify per configuration value encryption derived subkey (called "subpurposes", idea borrowed originally from Data Protection API). If you do not like this tokenization, you can replace it with any other one you prefer by crafting a regular expression with the constraint that it extracts the <code>&lt;encrypted data&gt;</code> substring in a group called <code>protectedData </code>and the &lt;<code>subPurposePattern&gt;</code> and <code>&lt;subPurpose&gt;&nbsp;</code>substrings in two groups called respectively <code>subPurposePattern</code> and <code>subPurpose.</code></p>
		</li>		<li>		<p><code>ProtectRegex</code>: It is a regular expression which specifies the tokenization tag which encloses the data to be encrypted; again it must define a named group called this time&nbsp;<code>protectData </code>(and optionally two additional groups called <code>subPurposePattern </code>and <code>subPurpose </code>for specifying a per configuration value subkey). If <code>null</code>, this parameter assumes the default value (e.g.&nbsp;<code>Protect:{&lt;subPurpose&gt;}:{&lt;data to be encrypted&gt;}</code>):</p>

		<div class="pre-lang" id="premain500452"><div>C#</div><div class="pre-action-link"><span id="copycode500452" class="copy-code" data-index="500452" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre500452" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectRegexString = <span class="code-string">"</span><span class="code-string">Protect(?&lt;subPurposePattern&gt;(:{(?&lt;subPurpose&gt;[^:}]+)})?):{(?&lt;protectData&gt;.*?)}"</span>;</pre>
		</li>		<li>		<p><code>DefaultProtectedReplaceString:</code> It is a string expression used to transform the plaintext tokenization into the encrypted tokenization (e.g. from&nbsp;<code>Protect:{&lt;subPurpose&gt;}:{&lt;data to be encrypted&gt;}</code> into&nbsp;<code>Protected:{&lt;subPurpose&gt;}:{&lt;encrypted data&gt;}</code>). It contains two placeholders <code>${subPurposePattern}</code> and <code>${protectedData}</code>&nbsp;which gets substituted respectively with the subPurposePattern (if present) and the encrypted data.&nbsp;If <code>null</code>, this parameter assumes the default value:</p>
		</li>	</ul>
	</li></ul>

<div class="pre-lang" id="premain57223"><div>C#</div><div class="pre-action-link"><span id="copycode57223" class="copy-code" data-index="57223" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre57223" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> <span class="code-keyword">const</span> <span class="code-sdkkeyword">String</span> DefaultProtectedReplaceString = <span class="code-string">"</span><span class="code-string">Protected${subPurposePattern}:{${protectedData}}"</span>;</pre>

<ul style="margin-left: 40px">
	<li><code>ProtectProvider: </code>a class implementing the <code>IProtectProvider</code> interface for specifying a pluggable logic for encryption/decryption. This interface is made up of three methods:

	<ul>
		<li><code>Encrypt</code>: which takes a plain text string and returns an encrypted base64 string.</li>		<li>		<p><code>Decrypt</code>: which takes a base64 encrypted string and returns the plain text string</p>
		</li>		<li>		<p><code>CreateNewProviderFromSubkey</code>: for supporting the per configuration value encryption derived subkey. It takes a subkey string parameter which should be used as encryption subkey to create a new derived <code>IProtectProvider </code>interface.</p>
		</li>	</ul>
	</li></ul>

<div class="pre-lang" id="premain53571"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="53571" id="preShrink53571">Shrink ▲</span> &nbsp; <span id="copycode53571" class="copy-code" data-index="53571" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre53571" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> A standard interface which must implement by an encryption/decryption provider
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">interface</span> IProtectProvider
{
    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> This method encrypts a plain-text string 
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="plainTextValue"</span><span class="code-summarycomment">&gt;</span>the plain-text string to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the encrypted string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-sdkkeyword">String</span> Encrypt(<span class="code-sdkkeyword">String</span> plainTextValue);


    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> This method decrypts an encrypted string 
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="encryptedValue"</span><span class="code-summarycomment">&gt;</span>the encrypted string to be decrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the decrypted string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-sdkkeyword">String</span> Decrypt(<span class="code-sdkkeyword">String</span> encryptedValue);


    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> This methods create a new <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> for supporting per configuration value encryption subkey (e.g. "subpurposes")
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="subkey"</span><span class="code-summarycomment">&gt;</span>the per configuration value encryption subkey<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span>    <span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a derived <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> based on the <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="subkey"/</span><span class="code-summarycomment">&gt;</span> parameter<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span>    IProtectProvider CreateNewProviderFromSubkey(<span class="code-keyword">string</span> subkey);
}</pre>

<ul class="method" style="margin-left: 40px">
	<li><code>CheckConfigurationIsValid</code><code>:</code> it is a base virtual (e.g. overrideable) method which basically checks that the <code>IProtectProviderConfigurationData</code> configuration is valid, if not it raises an exception with the details. It is called every time you add an&nbsp;<code>IProtectProviderConfigurationData</code> to <code>ProtectedConfigurationBuilder,&nbsp;</code>either globally in the constructor either locally with the extension method&nbsp;<code>WithProtectedConfigurationOptions.</code> Moreover it is also called during&nbsp;<a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectProviderConfigurationData.cs#L123-L142"><code>ProtectProviderConfigurationData.Merge</code></a>&nbsp;to check that the resulting configuration is valid and when performing encryption with&nbsp;<code>IProtectProviderConfigurationData.Protect...</code>&nbsp;methods.</li></ul>

<ul class="method">
	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected/ProtectedConfigurationProvider.cs"><code>ProtectedConfigurationProvider</code></a>: This class performs the actual transparent decryption of encrypted configuration values stored inside any existing configuration source. It should also support even future configuration sources as long as the <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationProvider.cs#L61-L94">implementation of the GetChildKeys of Microsoft.Extensions.Configuration.ConfigurationProvider</a> does not change (I principally use it to enumerate all possible configuration keys). Essentially, it takes in its constructor as input the <code>IConfigurationProvider</code> that needs to be decrypted and acts as a proxy:

	<ul class="none">
		<li>		<p>It redefines the <code>Load</code> method by calling after input <code>IConfigurationProvider.Load</code> the method responsible for the actual decryption <code>DecryptChildKeys</code>. This method initially used&nbsp;the standard method <code>GetChildKeys</code> offered by the <code>IConfigurationProvider</code> interface to enumerate all the existing configuration keys and decrypt them by matching the <code>ProtectedRegex</code> stored inside <code>ProtectProviderConfigurationData </code>and using <code>Decrypt</code> method of <code>ProtectProvider</code>. If the <code>subPurpose </code>group is present in the regex, a&nbsp;temporary derived <code>ProtectProvider</code> is created using <code>CreateNewProviderFromSubkey </code>method and used to perform decryption. With version 1.0.15 of the package I added a faster method for decrypting the child keys, it uses <code>reflection&nbsp;</code>just to retrieve the key-value dictionary inside the <code>ConfigurationProvider.Data</code> protected property (reflection should be avoided as much as possible, but in this case it is needed since the property is not public, moreover it is only used to retrieve only the dictionary, not the key-values entries). The speed increase is around 3000 times (yes 3k times!) and it should be supported by&nbsp;all Microsoft provided <code>ConfigurationProviders</code> (e.g.&nbsp;<code>XmlConfigurationProvider</code>, <code>JsonConfigurationProvider</code>, <code>MemoryConfigurationProvider</code>, <code>CommandLineConfigurationProvider</code>, <code>EnvironmentVariablesConfigurationProvider</code>) . This method is hacky but it is used in a safe mode, e.g. if the <code>IConfigurationProvider </code>object<code>&nbsp;</code>being decrypted&nbsp;is not an instance of <code>ConfigurationProvider </code>class and the class does not contain a property named&nbsp;<code>Data</code>&nbsp;the old slower recursive method is used.</p>

		<div class="pre-lang" id="premain601665"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="601665" id="preShrink601665">Shrink ▲</span> &nbsp; <span id="copycode601665" class="copy-code" data-index="601665" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre601665" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Calls the underlying provider Load method in order to 
</span><span class="code-summarycomment">///</span><span class="code-comment"> load configuration values and then decrypts them by calling 
</span><span class="code-summarycomment">///</span><span class="code-comment"> DecryptChildKeys helper method
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">virtual</span> <span class="code-keyword">void</span> Load()
{
    Provider.Load();

    <span class="code-comment">//</span><span class="code-comment"> call DecryptChildKeys after Load</span>
    DecryptChildKeys();
} 




<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Static PropertyInfo of protected property Data of Microsoft.Extensions.Configuration.ConfigurationProvider class (even though it is protected and not available here, you can use reflection in order to retrieve its value)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">static</span> PropertyInfo ConfigurationProviderDataProperty = <span class="code-keyword">typeof</span>(ConfigurationProvider).GetProperty(<span class="code-string">"</span><span class="code-string">Data"</span>, BindingFlags.NonPublic | BindingFlags.Instance);



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Hacky and fastest, tough safe method which gives access to the provider Data dictionary in readonly mode (it could be null in the future or for other providers not deriving from ConfigurationProvider, be sure to always check that it is not null!)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> IReadOnlyDictionary&lt;String, String&gt; ProviderDataReadOnly
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">get</span>
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IDictionary&lt;String, String&gt; providerData = ProviderData;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (providerData != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> <span class="code-keyword">new</span> ReadOnlyDictionary&lt;String, String&gt;(providerData);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> <span class="code-keyword">null</span>;
&nbsp;&nbsp; &nbsp;}
}




<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Hacky and fastest, tough safe method which gives access to the provider Data dictionary (it could be null in the future or for other providers not deriving from ConfigurationProvider, be sure to always check that it is not null!)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">protected</span> IDictionary&lt;String, String&gt; ProviderData
{
&nbsp;&nbsp; &nbsp;<span class="code-keyword">get</span>
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IDictionary&lt;String, String&gt; providerData = <span class="code-keyword">null</span>;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (Provider <span class="code-keyword">is</span> ConfigurationProvider &amp;&amp; ConfigurationProviderDataProperty != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;providerData = ConfigurationProviderDataProperty.GetValue(Provider) <span class="code-keyword">as</span> IDictionary&lt;string, string&gt;;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> providerData;
&nbsp;&nbsp; &nbsp;}
}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> This is a helper method actually responsible for the decryption of all configuration values. It decrypts all values using just IConfigurationBuilder interface methods so it should work on any existing or even future IConfigurationProvider <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Note: unluckily there Data dictionary property of ConfigurationProvider is not exposed on the interface IConfigurationProvider, but we can manage to get all keys by using the GetChildKeys methods, look at its implementation <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationProvider.cs#L61-L94"/</span><span class="code-summarycomment">&gt;</span> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> The only drawback of this method is that it returns the child keys of the level of the hierarchy specified by the parentPath parameter (it's at line 84 in MS source code "Segment(kv.Key, parentPath.Length + 1)" <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationProvider.cs#L84"/</span><span class="code-summarycomment">&gt;</span>) <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> So you have to use a recursive function to gather all existing keys and also to issue a distinct due to the way the GetChildKeys method has been implemented <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">br</span><span class="code-summarycomment"> </span><span class="code-summarycomment">/</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="parentPath"</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">protected</span> <span class="code-keyword">void</span> DecryptChildKeys(<span class="code-sdkkeyword">String</span> parentPath = <span class="code-keyword">null</span>)
{
&nbsp;&nbsp; &nbsp;IDictionary&lt;String, String&gt; dataProperty;

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> this is a hacky yet safe way to speed up key enumeration</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> we access the Data dictionary of ConfigurationProvider using reflection avoiding enumerating all keys with recursive function</span>
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> the speed improvement is more 3000 times!</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (((dataProperty = ProviderData) != <span class="code-keyword">null</span>))
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> key <span class="code-keyword">in</span> dataProperty.Keys.ToList())
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!String.IsNullOrEmpty(dataProperty[key]))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Provider.Set(key, ProtectProviderConfigurationData.ProtectedRegex.Replace(dataProperty[key], me =&gt;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> subPurposePresent = !String.IsNullOrEmpty(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>]?.Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IProtectProvider protectProvider = ProtectProviderConfigurationData.ProtectProvider;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (subPurposePresent)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;protectProvider = protectProvider.CreateNewProviderFromSubkey(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>].Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> protectProvider.Decrypt(me.Groups[<span class="code-string">"</span><span class="code-string">protectedData"</span>].Value);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}));
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;<span class="code-keyword">else</span>
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> key <span class="code-keyword">in</span> Provider.GetChildKeys(<span class="code-keyword">new</span> List&lt;String&gt;(), parentPath).Distinct())
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> fullKey = parentPath != <span class="code-keyword">null</span> ? $<span class="code-string">"</span><span class="code-string">{parentPath}:{key}"</span> : key;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (Provider.TryGet(fullKey, <span class="code-keyword">out</span> <span class="code-keyword">var</span> <span class="code-sdkkeyword">value</span>))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!String.IsNullOrEmpty(<span class="code-sdkkeyword">value</span>))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Provider.Set(fullKey, ProtectProviderConfigurationData.ProtectedRegex.Replace(<span class="code-sdkkeyword">value</span>, me =&gt;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> subPurposePresent = !String.IsNullOrEmpty(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>]?.Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IProtectProvider protectProvider = ProtectProviderConfigurationData.ProtectProvider;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (subPurposePresent)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;protectProvider = protectProvider.CreateNewProviderFromSubkey(me.Groups[<span class="code-string">"</span><span class="code-string">subPurpose"</span>].Value);

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">return</span> protectProvider.Decrypt(me.Groups[<span class="code-string">"</span><span class="code-string">protectedData"</span>].Value);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}));
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">else</span> DecryptChildKeys(fullKey);
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}
&nbsp;&nbsp; &nbsp;}
}</pre>

		<p>It creates its own <code>ReloadToken </code>if the underlying <code>IConfigurationProvider</code> supports it, it returns it in the <code>GetReloadToken</code> method and finally it registers a callback to the input <code>IConfigurationProvider</code> reload token using the framework static utility method <code>ChangeToken.OnChange</code> class in order to be notified of any configuration change re-performing the decryption in order to support to automatic decryption of values on configuration reload</p>

		<div class="pre-lang" id="premain466574"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="466574" id="preShrink466574">Shrink ▲</span> &nbsp; <span id="copycode466574" class="copy-code" data-index="466574" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre466574" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">public</span> ProtectedConfigurationProvider(IConfigurationProvider provider, ProtectedConfigurationData protectedConfigurationData)
{
    Provider = provider;
    ProtectedConfigurationData = protectedConfigurationData;

    RegisterReloadCallback();
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Registers a reload callback which redecrypts all values if the underlying IConfigurationProvider supports it
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">protected</span> <span class="code-keyword">void</span> RegisterReloadCallback()
{
    <span class="code-comment">//</span><span class="code-comment"> check if underlying provider supports reloading</span>
    <span class="code-keyword">if</span> (Provider.GetReloadToken() != <span class="code-keyword">null</span>)
    {
        <span class="code-comment">//</span><span class="code-comment"> Create our reload token</span>
        ReloadToken = <span class="code-keyword">new</span> ConfigurationReloadToken();

        <span class="code-comment">//</span><span class="code-comment"> registers Provider on Change event using framework static utility method ChangeToken.OnChange in order to be notified of configuration reload and redecrypts subsequently the needed keys</span>
        ProviderReloadTokenRegistration = ChangeToken.OnChange(() =&gt; Provider.GetReloadToken(), (configurationProvider) =&gt;
        {
            <span class="code-keyword">var</span> protectedConfigurationProvider = configurationProvider <span class="code-keyword">as</span> ProtectedConfigurationProvider;

            <span class="code-comment">//</span><span class="code-comment"> redecrypts all needed keys</span>
            protectedConfigurationProvider.DecryptChildKeys();

            <span class="code-comment">//</span><span class="code-comment"> notifies all subscribes</span>
            OnReload();
        }, <span class="code-keyword">this</span>);
    }
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Returns our reload token
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ReloadToken"/</span><span class="code-summarycomment">&gt;</span><span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> IChangeToken GetReloadToken()
{
    <span class="code-keyword">return</span> ReloadToken;
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Dispatches all the callbacks waiting for the reload event from 
</span><span class="code-summarycomment">///</span><span class="code-comment"> this configuration provider (and creates a new ReloadToken)
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">protected</span> <span class="code-keyword">virtual</span> <span class="code-keyword">void</span> OnReload()
{
    ConfigurationReloadToken previousToken = 
      Interlocked.Exchange(<span class="code-keyword">ref</span> ReloadToken, <span class="code-keyword">new</span> ConfigurationReloadToken());
    previousToken.OnReload();
}</pre>
		</li>	</ul>
	</li></ul>

<h3 id="PointsOfInterest">Code inside Fededim.Extensions.Configuration.Protected.DataProtectionAPI package</h3>

<ul>
	<li><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.DataProtectionAPI/DataProtectionAPIProtectConfigurationData.cs"><code>DataProtectionAPIProtectConfigurationData</code></a>: This class chiefly stores either the global configuration or the <code>ConfigurationSource</code> specific one for Data Protection API and the eventual custom tokenization regular expressions. It also sets up another dependency injection provider in the main constructor (see above for the reason) and it provides two overloads one for <code>keyNumber </code>and one for <code>purposeString</code>. Besides these two main constructors there are several other overloads provided for usability.

	<div class="pre-lang" id="premain164525"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="164525" id="preShrink164525">Shrink ▲</span> &nbsp; <span id="copycode164525" class="copy-code" data-index="164525" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre164525" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Main constructor for DataProtectionAPIProtectConfigurationData using a key number
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectRegexString"</span><span class="code-summarycomment">&gt;</span>a regular expression which captures the data to be encrypted in a named group called protectData<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectedRegexString"</span><span class="code-summarycomment">&gt;</span>a regular expression which captures the data to be decrypted in a named group called protectedData<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectedReplaceString"</span><span class="code-summarycomment">&gt;</span>a string replacement expression which captures the substitution which must be applied for transforming unencrypted tokenization into an encrypted tokenization<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="dataProtectionServiceProvider"</span><span class="code-summarycomment">&gt;</span>a service provider configured with Data Protection API, this parameters is mutually exclusive to dataProtectionConfigureAction<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="dataProtectionConfigureAction"</span><span class="code-summarycomment">&gt;</span>a configure action to setup the Data Protection API, this parameters is mutually exclusive to dataProtectionServiceProvider<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="keyNumber"</span><span class="code-summarycomment">&gt;</span>a number specifying the index of the key to use<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">exception</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ArgumentException"</span><span class="code-summarycomment">&gt;</span>if dataProtectionServiceProvider or dataProtectionServiceProvider is null or not well configured<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/exception</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> DataProtectionAPIProtectConfigurationData(<span class="code-sdkkeyword">String</span> protectRegexString = <span class="code-keyword">null</span>, <span class="code-sdkkeyword">String</span> protectedRegexString = <span class="code-keyword">null</span>, <span class="code-sdkkeyword">String</span> protectedReplaceString = <span class="code-keyword">null</span>, IServiceProvider dataProtectionServiceProvider = <span class="code-keyword">null</span>, Action&lt;IDataProtectionBuilder&gt; dataProtectionConfigureAction = <span class="code-keyword">null</span>, <span class="code-keyword">int</span> keyNumber = <span class="code-digit">1</span>)
&nbsp;&nbsp; &nbsp;: <span class="code-keyword">this</span>(protectRegexString, protectedRegexString, protectedReplaceString, dataProtectionServiceProvider, dataProtectionConfigureAction, DataProtectionAPIProtectConfigurationKeyNumberToString(keyNumber))
{

}



<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> Main constructor for DataProtectionAPIProtectConfigurationData using a purpose string
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectRegexString"</span><span class="code-summarycomment">&gt;</span>a regular expression which captures the data to be encrypted in a named group called protectData<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectedRegexString"</span><span class="code-summarycomment">&gt;</span>a regular expression which captures the data to be decrypted in a named group called protectedData<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="protectedReplaceString"</span><span class="code-summarycomment">&gt;</span>a string replacement expression which captures the substitution which must be applied for transforming unencrypted tokenization into an encrypted tokenization<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="dataProtectionServiceProvider"</span><span class="code-summarycomment">&gt;</span>a service provider configured with Data Protection API, this parameters is mutually exclusive to dataProtectionConfigureAction<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="dataProtectionConfigureAction"</span><span class="code-summarycomment">&gt;</span>a configure action to setup the Data Protection API, this parameters is mutually exclusive to dataProtectionServiceProvider<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="purposeString"</span><span class="code-summarycomment">&gt;</span>a string used to derive the encryption key<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">exception</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="ArgumentException"</span><span class="code-summarycomment">&gt;</span>if dataProtectionServiceProvider or dataProtectionServiceProvider is null or not well configured<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/exception</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> DataProtectionAPIProtectConfigurationData(<span class="code-sdkkeyword">String</span> protectRegexString = <span class="code-keyword">null</span>, <span class="code-sdkkeyword">String</span> protectedRegexString = <span class="code-keyword">null</span>, <span class="code-sdkkeyword">String</span> protectedReplaceString = <span class="code-keyword">null</span>, IServiceProvider dataProtectionServiceProvider = <span class="code-keyword">null</span>, Action&lt;IDataProtectionBuilder&gt; dataProtectionConfigureAction = <span class="code-keyword">null</span>, <span class="code-sdkkeyword">String</span> purposeString = <span class="code-keyword">null</span>)
{
&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> check that at least one parameter is not null</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (dataProtectionServiceProvider == <span class="code-keyword">null</span> &amp;&amp; dataProtectionConfigureAction == <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">Either dataProtectionServiceProvider or dataProtectionConfigureAction must not be null!"</span>);

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> if dataProtectionServiceProvider is null and we pass a dataProtectionConfigureAction configure a new service provider</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (dataProtectionServiceProvider == <span class="code-keyword">null</span> &amp;&amp; dataProtectionConfigureAction != <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> services = <span class="code-keyword">new</span> ServiceCollection();
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;dataProtectionConfigureAction(services.AddDataProtection());
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;dataProtectionServiceProvider = services.BuildServiceProvider();
&nbsp;&nbsp; &nbsp;}

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> check that dataProtectionServiceProvider resolves the IDataProtector</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">var</span> dataProtect = dataProtectionServiceProvider.GetRequiredService&lt;IDataProtectionProvider&gt;().CreateProtector(DataProtectionAPIProtectConfigurationStringPurpose(purposeString));
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (dataProtect == <span class="code-keyword">null</span>)
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span class="code-keyword">throw</span> <span class="code-keyword">new</span> ArgumentException(<span class="code-string">"</span><span class="code-string">Either dataProtectionServiceProvider or dataProtectionConfigureAction must configure the DataProtection services!"</span>, dataProtectionServiceProvider == <span class="code-keyword">null</span> ? <span class="code-keyword">nameof</span>(dataProtectionServiceProvider) : <span class="code-keyword">nameof</span>(dataProtectionConfigureAction));

&nbsp;&nbsp; &nbsp;<span class="code-comment">//</span><span class="code-comment"> sets the abstract class base properties and calls CheckConfigurationIsValid</span>
&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!String.IsNullOrEmpty(protectRegexString))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectRegex = <span class="code-keyword">new</span> Regex(protectRegexString);

&nbsp;&nbsp; &nbsp;<span class="code-keyword">if</span> (!String.IsNullOrEmpty(protectedRegexString))
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProtectedRegex = <span class="code-keyword">new</span> Regex(protectedRegexString);

&nbsp;&nbsp; &nbsp;ProtectedReplaceString = protectedReplaceString;

&nbsp;&nbsp; &nbsp;ProtectProvider = <span class="code-keyword">new</span> DataProtectionAPIProtectProvider(dataProtect);

&nbsp;&nbsp; &nbsp;CheckConfigurationIsValid();
}</pre>
	</li>	<li>	<p><a href="https://github.com/fededim/Fededim.Extensions.Configuration.Protected/blob/master/Fededim.Extensions.Configuration.Protected.DataProtectionAPI/DataProtectionAPIProtectProvider.cs">DataProtectionAPIProtectProvider</a> it is the implementation of the <code>IProtectProvider </code>interface using the Microsoft Data Protection API (e.g. calls&nbsp;<code>IDataProtector.Unprotect</code> for <code>Decrypt</code>, <code>IDataProtector.Protect</code> for <code>Encrypt</code>, <code>IDataProtector.CreateProtector </code>for <code>CreateNewProviderFromSubkey).</code></p>
	</li></ul>

<div class="pre-lang" id="premain628029"><div>C#</div><div class="pre-action-link"><span class="code-collapse" data-index="628029" id="preShrink628029">Shrink ▲</span> &nbsp; <span id="copycode628029" class="copy-code" data-index="628029" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre628029" style="margin-top:0;" class="lang-csharp notranslate" data-language="cs" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> The standard Microsoft DataProtectionAPI protect provider for Fededim.Extensions.Configuration.Protected, implementing the <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> interface.
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-keyword">class</span> DataProtectionAPIProtectProvider : IProtectProvider
{
<span class="code-keyword">public</span> IDataProtector DataProtector { <span class="code-keyword">get</span>; }

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> The main constructor
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="dataProtector"</span><span class="code-summarycomment">&gt;</span>the <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IDataProtect"/</span><span class="code-summarycomment">&gt;</span> interface obtained from Data Protection API<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> DataProtectionAPIProtectProvider(IDataProtector dataProtector)
{
    DataProtector = dataProtector;
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> This methods create a new <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> for supporting per configuration value encryption subkey (e.g. "subpurposes")
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="subkey"</span><span class="code-summarycomment">&gt;</span>the per configuration value encryption subkey<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>a derived <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="IProtectProvider"/</span><span class="code-summarycomment">&gt;</span> based on the <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">see</span><span class="code-summarycomment"> </span><span class="code-summarycomment">cref="subkey"/</span><span class="code-summarycomment">&gt;</span> parameter<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> IProtectProvider CreateNewProviderFromSubkey(<span class="code-sdkkeyword">String</span> subkey)
{
    <span class="code-keyword">return</span> <span class="code-keyword">new</span> DataProtectionAPIProtectProvider(DataProtector.CreateProtector(subkey));
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> This method decrypts an encrypted string 
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="encryptedValue"</span><span class="code-summarycomment">&gt;</span>the encrypted string to be decrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the decrypted string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-sdkkeyword">String</span> Decrypt(<span class="code-sdkkeyword">String</span> encryptedValue)
{
    <span class="code-keyword">return</span> DataProtector.Unprotect(encryptedValue);
}

<span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> This method encrypts a plain-text string 
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/summary</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">param</span><span class="code-summarycomment"> </span><span class="code-summarycomment">name="plainTextValue"</span><span class="code-summarycomment">&gt;</span>the plain-text string to be encrypted<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/param</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-summarycomment">///</span><span class="code-comment"> <span class="code-summarycomment">&lt;</span><span class="code-summarycomment">returns</span><span class="code-summarycomment">&gt;</span>the encrypted string<span class="code-summarycomment">&lt;</span><span class="code-summarycomment">/returns</span><span class="code-summarycomment">&gt;</span>
</span><span class="code-keyword">public</span> <span class="code-sdkkeyword">String</span> Encrypt(<span class="code-sdkkeyword">String</span> plainTextValue)
{
    <span class="code-keyword">return</span> DataProtector.Protect(plainTextValue);
}
}</pre>

<h2>Points of Interest</h2>

<p>I think that the idea of specifying the custom tag through a regex is very witty because it gives every user the flexibility they need to customize the tokenization tag.</p>

<p>It's strange that MS did not plan a method or a property inside <code>IConfigurationProvider</code> to enumerate all possible keys of a provider,<code> </code>probably (and hopefully), it will be added in future releases so I could avoid using the non efficient recursive <code>GetChildKeys</code> method to enumerate all keys.</p>

<p>If you wonder whether you can use this package in your project and it will still be working in the future, I can underline that the only critical point is the enumeration of all configuration keys which is now done by using the <code>GetChildKeys </code>method. Even if its implementation could be changed by Microsoft, it will always provide what its name states, e.g., the child keys of a configuration key. And even in the remote case that the <code>GetChildKeys </code>method will be removed from the <code>IConfigurationProvider</code> interface, you can always access all configuration keys by casting the interface to the <code>ConfigurationProvider </code>base class and access the protected <code>Data&nbsp;</code>property through reflection (please see the comment in <code>CreateProtectedConfigurationProvider&nbsp;</code>method, basically all configuration providers derive from this class), so I am quite confident that the package will be working for many years.</p>

<p>In addition since version 1.0.12 the package allows pluggable encryption/decryption in case you want for whatever reason (alleged Microsoft hidden backdoors, open source product&nbsp;aficionado, etc.)&nbsp;not to use the default provider <code>Fededim.Extensions.Configuration.Protected.DataProtectionAPI</code> based on&nbsp;Microsoft Data Protection API.</p>

<p>Furthermore since version 1.0.16 of <code>Fededim.Extensions.Configuration.Protected</code> I implemented the safe&nbsp;casting of the <code>IConfigurationProvider</code>&nbsp;being decrypted&nbsp;to the <code>ConfigurationProvider </code>base class&nbsp; in order to make&nbsp;child keys enumeration process unbelievably fast. On top of that I have recently added an&nbsp;<code>xUnit </code>test project in order&nbsp;to improve the reliability and the software quality of these&nbsp;two packages: on my personal laptop (Intel I9-13900K based) I have successfully tested it with 2*100000 random keys inside five tests cases, each one dealing with the <em>framework provided&nbsp;ConfigurationProviders&nbsp;</em>(<strong>CommandLineConfigurationProvider</strong>, <strong>Environment<wbr>Variables<wbr>Configuration<wbr>Provider</strong>, <strong>MemoryConfigurationProvider</strong>, <strong>JsonConfigurationProvider </strong><em>[two&nbsp;passes, one using JsonProtectFileProcessor and one using JsonWithCommentsProtectFileProcessor]</em>, <strong>XmlConfigurationProvider</strong>). For example a test case on the <em>JsonConfigurationProvider&nbsp;</em>generated a plain-text file with a total size of 60MB and an encrypted file with a total size of 91MB, the test&nbsp;has ended in around 10&nbsp;seconds for generating the&nbsp;random JSON file, encrypting it, decrypting it using the <code>ProtectedConfigurationBuilder&nbsp;</code><em>(in order to decrypt 250k encrypted values this step took around 5&nbsp;seconds in .Net462 and around 3 seconds in net6.0 which is faster)</em> and checking that every decrypted key was equal to the plaintext one. <strong>Moreover all the whole set of five test cases was repeated for 1000 iterations</strong> (Test Explorer Run Until Failure, unluckily it is not available for the whole suite of tests, I had to do it separately), both<strong> for net462 (total runtime 705 minutes)</strong>&nbsp;and <strong>net6.0 (total runtime 424 minutes)</strong> without raising any error&nbsp;as you can see in the pictures below.<br>
<br>
<strong>Net462 Endurance Test</strong><br>
<img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png" alt="Image 2" data-src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png" class="lazyautosizes lazyloaded" style="cursor: pointer; border: 0; width: 700px; height: auto" onclick="imageCleanup.showFullImage(&#39;./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png&#39;)" data-sizes="auto" data-srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 1920w" sizes="700px" srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net462_Endurance_Test.png 1920w"></p>

<p><strong>Net6.0 Endurance Test</strong><br>
<img src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png" alt="Image 3" data-src="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png" class="lazyautosizes lazyloaded" style="cursor: pointer; border: 0; width: 700px; height: auto" onclick="imageCleanup.showFullImage(&#39;./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png&#39;)" data-sizes="auto" data-srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 1920w" sizes="700px" srcset="./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 400w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 700w, ./Fededim.Extensions.Configuration.Protected.DataProtectionAPI_files/Net60_Endurance_Test.png 1920w"></p>

<p>Last but not the least, I want to remind everyone that the <code>protected </code>member access modifier does exist! I have seen it being used rarely as compared to <code>private</code>, sometimes even inside the .NET framework classes! It should be used instead as the default member access modifier with very little or almost none <code>private </code>members, since it allows <code>inheritance </code>which is the basis of object-oriented programming (you never know who wants to extend and customize your classes for their or other general needs).</p>

<h2>History</h2>

<ul>
	<li>V1.0.0 (16<sup>th</sup> December, 2023)

	<ul>
		<li>Initial version</li>	</ul>
	</li>	<li>V1.0.1 (27<sup>th</sup> December, 2023)
	<ul>
		<li>Added further code in implementation details sections of <code>ConfigurationBuilderExtensions, ProtectedConfigurationBuilder</code> and <code>ProtectedConfigurationProvider</code></li>		<li>Explained better how automatic decryption of values on configuration reload works in implementation details sections</li>	</ul>
	</li>	<li>V1.0.2 (30<sup>th</sup> December, 2023)
	<ul>
		<li>Improved the <code>ConfigureDataProtection</code> explanation and added link to Data Protection purpose string documentation</li>		<li>Added point in "<a href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult#PointsOfInterest">Points of Interest</a>" section about missing method or property on MS <code>IConfigurationProvider</code> to enumerate all keys</li>		<li>Fixed some typos</li>	</ul>
	</li>	<li>V1.0.3 (7<sup>th</sup> February, 2024)
	<ul>
		<li>Commented 3 lines of unneeded code in <code>CreateProtectedConfigurationProvider</code> method of <code>ProtectedConfigurationBuilder</code></li>		<li>Released NuGet package version 1.0.5</li>	</ul>
	</li>	<li>V1.0.4 (8<sup>th</sup> February, 2024)
	<ul>
		<li>Added point in <a href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult#PointsOfInterest">Points of Interest</a> section about the critical points of this package and its likelihood to be still working in the future</li>		<li>Added point in <a href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult#PointsOfInterest">Points of Interest</a> section about fostering the usage of protected member access modifier</li>	</ul>
	</li>	<li>V1.0.5 (4<sup>th</sup> May, 2024)
	<ul>
		<li>Released NuGet package version 1.0.6</li>		<li>Updated paragraphs and code to reflect code changes (e.g. <code>ConfigurationBuilderExtensions</code>. <code>IDataProtect.ProtectFiles </code>and <code>Protected.ConsoleTest</code>)</li>		<li>Added source code hyperlinks to appsetting.json, appsettings.development.json and appsettings.xml files</li>	</ul>
	</li>	<li>V1.0.6 (8<sup>th</sup> May, 2024)
	<ul>
		<li>Released NuGet package version 1.0.7</li>		<li>Updated paragraphs and code to reflect code changes (e.g. <code>ConfigurationBuilderExtensions</code>, <code>ProtectedConfigurationProvider. RegisterReloadCallback</code> and <code>Protected.ConsoleTest</code>)</li>	</ul>
	</li>	<li>V1.0.7 (31<sup>th </sup>May, 2024)
	<ul>
		<li>Released NuGet package version 1.0.10</li>		<li>Updated paragraphs and code to reflect code changes (e.g. <code>ProtectFiles, ProtectConfigurationValue</code> and <code>WithProtectedConfigurationOptions</code> inside <code>ConfigurationBuilderExtensions</code>, <code>ProtectedConfigurationProvider.DecryptChildKeys</code>, <code>ProtectedConfigurationData</code> constructors, <code>ProtectedConfigurationBuilder</code> constructors and regex strings, added a new file <em>ProtectFileProcessors.cs</em> with <code>IFileProtectProcessor</code>, <code>FilesProtectOptions</code>, <code>RawFileProtectProcessor</code>, <code>JsonFileProtectProcessor</code>, <code>XmlFileProtectProcessor</code>)</li>	</ul>
	</li>	<li>V1.0.8 (18<sup>th </sup>June, 2024)
	<ul>
		<li>Released NuGet package version 1.0.13 and extracted Data Protection API encryption/decryption code into a new provider package called Fededim.Extensions.Configuration.Protected.DataProtectionAPI</li>		<li>Updated different paragraphs and code to reflect code changes (too many to quote them)</li>	</ul>
	</li>	<li>V1.0.9&nbsp;(26<sup>th </sup>June, 2024)
	<ul>
		<li>Released Fededim.Extensions.Configuration.Protected NuGet package version 1.0.14 together with&nbsp;Fededim.Extensions.Configuration.Protected.DataProtectionAPI version 1.0.2</li>		<li>Updated different paragraphs and code to reflect code changes</li>		<li>Added <code>xUnit </code>test project to improve reliability and software quality</li>	</ul>
	</li></ul>

<ul>
	<li>V1.0.10&nbsp;(28<sup>th </sup>June, 2024)

	<ul>
		<li>Released Fededim.Extensions.Configuration.Protected NuGet package version 1.0.16&nbsp;together with&nbsp;Fededim.Extensions.Configuration.Protected.DataProtectionAPI version 1.0.4</li>		<li>Made child keys enumeration process unbelievably fast (if the provider is derived from <code>ConfigurationProvider </code>like all <code>Microsoft </code>provided <code>ConfigurationProviders</code>, otherwise the old method is used)</li>		<li>Improved code and speed of <code>xUnit </code>test project</li>		<li>Bugfix on <code>ProtectEnvironmentVariables </code>(target environment was not passed)</li>	</ul>
	</li>	<li>V1.0.11 (3rd July, 2024)
	<ul>
		<li>Released Fededim.Extensions.Configuration.Protected NuGet package version 1.0.17&nbsp;together with&nbsp;Fededim.Extensions.Configuration.Protected.DataProtectionAPI version 1.0.5</li>		<li>Made <code>ProtectedConfigurationProvider.ProviderData</code> property safer using as instead of a direct cast</li>		<li>Added virtual to various methods in order to allow extensibility</li>		<li>Updated code to reflect code changes</li>	</ul>
	</li></ul>




						</div>
						

						
						<h2>License</h2>
						<div id="LicenseTerms"><p>This article, along with any associated source code and files, is licensed under <a href="http://www.codeproject.com/info/cpol10.aspx" rel="license">The Code Project Open License (CPOL)</a></p></div>
						

						
						<br>
						
						    <br>
						
						

						<div class="clearfix"></div>

						<div style="padding-top:8px">
							
						</div>

					

				    
					</form>

				</div>

				
				<div class="bottom-promo"> 
				    
				</div>
				
                
                

				
				
				

			</div>
			

            
            
            

        </div>
        

		
		<div class="site-footer">
			<div class="align-left">
				<a id="ctl00_PermaLink" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-DataPro">Permalink</a><br>
				<br>
				<a id="ctl00_PrivacyLink" href="https://www.codeproject.com/info/privacy.aspx">Privacy</a><br>
    			<a id="ctl00_CookiePolicyLink" href="https://www.codeproject.com/info/cookie.aspx">Cookies</a><br>
                <a id="ctl00_TermsOfUseLink" href="https://www.codeproject.com/info/TermsOfUse.aspx">Terms of Use</a><br>
			</div>

            <div class="align-center">
				


<div class="page-width">
    Layout: <a id="ctl00_PageWidth_FixedT" title="Fixed width layout" rel="nofollow" class=" active" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult?PageFlow=FixedWidth">fixed</a>
    |
    <a id="ctl00_PageWidth_FluidT" title="Fluid layout" rel="nofollow" href="https://www.codeproject.com/Articles/5374311/Fededim-Extensions-Configuration-Protected-The-Ult?PageFlow=Fluid">fluid</a>
</div>


				

				

	            

                <br>
			</div>
                
			<div class="align-right">
				Article Copyright 2023 by Federico Di Marco<br>Everything else
				Copyright © <a href="mailto:webmaster@codeproject.com">CodeProject</a>, 1999-2024<br>
                <br>
				Web01 
				2.8:2024-10-20:1<br>
			</div>
		</div>
		

		<br clear="all">
		
			

	</div> 
	</div> 
</div>







<script type="text/javascript"> // DEFERRED script

document.addEventListener('DOMContentLoaded', function() {

	new CodeBlocks().initialise('#contentdiv');
	
	$('.author-wrapper .description').shorten({showChars: 400});
	
	anchorAnimate();
	
	$('#__EVENTVALIDATION').attr('autocomplete', 'off');

})
</script>










<style type="text/css">.copied::after {  position: absolute;  right: 0;  display: inline-block; white-space: nowrap; content: 'copied'; color: #fff; background-color: #f90;  border-radius: 3px; padding:1px 8px; opacity: 0;  will-change: opacity, transform; animation: showcopied 1.5s ease; } @keyframes showcopied { 0% { opacity: 0; } 70% { opacity: 1; } 100% { opacity: 0; } } </style><canvas id="cv1" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas><canvas id="cv2" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas></body></html>